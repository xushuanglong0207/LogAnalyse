# NAS设备定时分析系统使用手册

## 概述

NAS设备定时分析系统是一个完整的日志监控解决方案，能够自动监控多个NAS设备的日志文件，检测错误模式，并通过邮件发送详细的错误报告。

## 系统特性

- 🖥️ **多设备管理** - 支持管理多个NAS设备，通过SSH连接进行远程监控
- 📊 **智能分析** - 基于DSL规则引擎，支持复杂的日志模式匹配
- ⏰ **定时监控** - 每小时自动执行监控脚本，检测新错误
- 📧 **邮件通知** - 每日下午3点自动发送错误报告邮件
- 🔐 **安全存储** - 设备密码加密存储，保证安全性
- 🎨 **友好界面** - 现代化Web界面，操作简单直观

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面      │───▶│   后端API       │───▶│   NAS设备       │
│   (React)       │    │   (FastAPI)     │    │   (SSH连接)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       ▼                       │
         │              ┌─────────────────┐              │
         │              │   数据库        │              │
         │              │   (PostgreSQL)  │              │
         │              └─────────────────┘              │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面      │    │   调度服务      │    │   监控脚本      │
│   管理配置      │    │   定时任务      │    │   错误检测      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 快速开始

### 1. 添加NAS设备

1. 进入"⏰ 定时分析"页面
2. 点击"+ 添加设备"按钮
3. 填写设备信息：
   - **设备名称**：便于识别的设备名称
   - **IP地址**：NAS设备的IP地址
   - **SSH端口**：默认为22
   - **SSH用户名**：具有足够权限的用户名
   - **SSH密码**：用户密码（加密存储）
   - **设备描述**：可选的设备用途说明

4. 点击"保存"完成设备添加

### 2. 测试设备连接

添加设备后，点击"🔗 测试连接"按钮验证设备连接状态：
- ✅ **连接成功**：设备可正常访问
- ❌ **连接失败**：检查网络连接、SSH配置、用户权限

### 3. 创建监控任务

1. 点击设备卡片上的"⏰ 添加任务"按钮
2. 配置监控任务：
   - **任务名称**：描述性的任务名称
   - **监控日志路径**：要监控的日志文件路径（如：/var/log/syslog）
   - **选择监控规则**：从已配置的DSL规则中选择
   - **邮件接收者**：错误报告邮件的接收地址
   - **邮件发送时间**：默认15:00（下午3点）

3. 点击"保存"创建监控任务

### 4. 配置邮件服务

在"📧 邮件服务配置"区域：
1. 检查SMTP配置状态
2. 点击"📧 测试邮件"验证邮件服务
3. 确保调度器运行状态为"🟢 运行中"

## 详细功能说明

### NAS设备管理

#### 设备状态说明
- **✅ 在线**：设备连接正常，可执行监控任务
- **❌ 离线**：设备连接失败，需要检查网络或配置
- **⚪ 未知**：尚未测试连接状态

#### 设备操作功能
- **🔗 测试连接**：验证SSH连接是否正常
- **📊 系统信息**：查看设备的系统信息（主机名、内核版本、内存使用等）
- **⏰ 添加任务**：为该设备创建新的监控任务
- **📋 错误日志**：查看设备上已生成的错误日志文件
- **✏️ 编辑**：修改设备配置信息
- **🗑️ 删除**：删除设备（需先删除关联的监控任务）

### 监控任务管理

#### 任务状态说明
- **🟢 运行中**：任务正在正常执行
- **🔴 错误**：任务执行出现异常
- **🟡 等待中**：任务等待下次执行
- **⚪ 已停止**：任务已停止执行

#### 任务配置详解

##### 1. 监控日志路径
支持多种格式：
```
单个文件：  /var/log/syslog
多个文件：  /var/log/syslog,/var/log/messages,/var/log/kern.log
通配符：    /var/log/*.log
```

##### 2. 监控规则选择
系统基于DSL（领域特定语言）进行规则匹配，支持：
- **关键词匹配**：`"low memory"` - 匹配包含"low memory"的行
- **逻辑运算**：`"error" & "critical"` - 同时包含error和critical
- **或运算**：`"OOM" | "Out of memory"` - 包含OOM或Out of memory
- **非运算**：`"error" ! "warning"` - 包含error但不包含warning
- **复合条件**：`("disk full" | "No space") & !"test"`

##### 3. 邮件配置
- 支持多个收件人，用逗号分隔
- 邮件发送时间可自定义（默认15:00）
- 系统会自动生成包含设备信息和错误详情的HTML邮件

### 监控脚本部署

#### 自动部署流程
1. **脚本生成**：根据选择的规则生成bash监控脚本
2. **远程部署**：通过SSH将脚本上传到设备的 `/home/{用户名}/nas-log-monitor/` 目录
3. **权限设置**：设置脚本执行权限
4. **定时任务**：配置crontab，每小时执行一次
5. **状态验证**：验证部署是否成功

#### 监控脚本功能
- **错误检测**：按照配置的规则检测日志中的错误
- **去重处理**：相同类型的错误会进行计数，避免重复报告
- **上下文提取**：保存错误的上下文信息便于分析
- **状态保存**：维护错误统计和首次发现时间
- **日志轮转**：按时间戳生成错误日志文件

### 邮件通知系统

#### 邮件内容结构
1. **设备信息**：设备名称、IP地址、监控路径等
2. **错误摘要**：总错误数、错误类型数、影响文件数
3. **错误详情**：每个错误的详细信息
   - 规则名称和描述
   - 出现次数和时间范围
   - 来源文件和示例内容
4. **建议操作**：根据错误情况提供的操作建议

#### 邮件发送策略
- **定时发送**：每日下午15:00自动发送
- **智能内容**：无错误时发送"监控正常"邮件
- **手动触发**：支持通过界面手动发送报告
- **发送记录**：记录邮件发送状态和时间

## 高级配置

### 环境变量配置

在后端应用中需要配置以下环境变量：

```bash
# SMTP邮件服务配置
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SENDER_EMAIL=your-email@gmail.com
SENDER_NAME=NAS日志监控系统
```

### 数据库迁移

系统使用SQLAlchemy进行数据库操作，主要表结构：

- **nas_devices**：NAS设备信息
- **monitor_tasks**：监控任务配置
- **monitor_logs**：监控日志记录
- **email_templates**：邮件模板（扩展功能）

### 权限要求

#### NAS设备端要求
- SSH服务已启用
- 用户具有以下权限：
  - 读取监控目标日志文件
  - 在用户家目录创建文件夹
  - 修改个人crontab配置
  - 执行系统信息查询命令

#### 网络要求
- 监控服务器能够通过SSH访问所有NAS设备
- 邮件服务器连接正常（SMTP端口587或25）
- 防火墙允许相关端口通信

## 故障排除

### 常见问题

#### 1. SSH连接失败
**症状**：设备状态显示"❌ 离线"
**解决方案**：
- 检查IP地址和端口是否正确
- 验证SSH服务是否运行：`sudo systemctl status ssh`
- 确认用户名密码是否正确
- 检查防火墙设置
- 验证SSH密钥认证配置

#### 2. 监控脚本部署失败
**症状**：任务状态显示"🔴 错误"
**解决方案**：
- 检查用户权限，确保能创建文件和目录
- 验证crontab服务运行状态：`sudo systemctl status cron`
- 手动执行脚本测试：`bash nas-log-monitor.sh`
- 检查日志文件路径是否存在且可读

#### 3. 邮件发送失败
**症状**：调度器运行但未收到邮件
**解决方案**：
- 检查SMTP配置是否正确
- 使用"📧 测试邮件"功能验证邮件服务
- 查看应用日志中的错误信息
- 确认邮件账户是否启用了应用程序密码
- 检查垃圾邮件文件夹

#### 4. DSL规则不生效
**症状**：明显的错误没有被检测到
**解决方案**：
- 检查DSL表达式语法是否正确
- 验证关键词是否区分大小写
- 测试规则是否支持跨行匹配
- 查看监控脚本生成的bash逻辑
- 检查日志文件编码格式

### 日志分析

#### 应用日志位置
- **后端日志**：检查FastAPI应用日志
- **调度器日志**：查看定时任务执行日志
- **设备端日志**：`/var/log/nas-monitor.log`

#### 常用调试命令
```bash
# 查看调度器状态
curl -H "Authorization: Bearer {token}" \
  http://localhost:8001/api/monitor/scheduler/status

# 手动触发邮件报告
curl -X POST -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"task_id": 1}' \
  http://localhost:8001/api/monitor/email/send-report

# 查看设备监控状态
ssh user@nas-device "ls -la ~/nas-log-monitor/"
ssh user@nas-device "crontab -l | grep nas-log-monitor"
```

## 性能优化

### 监控频率调整
- 默认每小时执行一次，可根据需要调整cron表达式
- 大文件监控建议使用`tail`命令只处理新增内容
- 合理设置日志保留期限，避免文件过大

### 规则优化
- 优先使用DSL规则而非复杂正则表达式
- 避免过于宽泛的匹配条件
- 定期审查和清理不必要的规则

### 邮件优化
- 合理设置邮件发送频率
- 使用邮件模板减少重复内容
- 配置邮件服务器连接池

## 扩展开发

### API接口文档
系统提供完整的RESTful API，支持：
- 设备管理（增删改查）
- 任务管理（配置、状态监控）
- 邮件服务（测试、手动发送）
- 调度器控制（状态查询）

### 自定义规则引擎
可以扩展DSL解析器，添加更多匹配功能：
```python
# 添加新的DSL操作符
class CustomDSLEvaluator(DSLEvaluator):
    def evaluate_custom_operator(self, expression):
        # 自定义逻辑
        pass
```

### 多租户支持
通过用户权限管理实现多租户：
- 设备按用户隔离
- 任务权限控制  
- 邮件通知范围限制

## 安全考虑

### 密码安全
- SSH密码使用Fernet加密存储
- 定期轮换设备访问密码
- 使用SSH密钥认证替代密码认证

### 网络安全
- 限制SSH访问来源IP
- 使用VPN连接内网设备
- 启用SSH访问日志监控

### 数据安全
- 定期备份监控配置和历史数据
- 敏感信息脱敏处理
- 实施访问审计和权限最小化原则

## 版本更新

### v1.0.0 功能特性
- ✅ 基础设备管理
- ✅ SSH连接和脚本部署
- ✅ DSL规则引擎
- ✅ 邮件通知系统
- ✅ Web管理界面
- ✅ 定时调度服务

### 计划功能
- 📊 **监控仪表板**：图表展示错误趋势
- 🔔 **多种通知方式**：支持短信、企业微信等
- 📱 **移动端适配**：响应式设计优化
- 🤖 **智能分析**：基于AI的异常检测
- 🔄 **高可用部署**：集群模式和负载均衡

## 技术支持

### 联系方式
- 📧 邮件支持：通过系统管理员联系
- 📚 在线文档：查看最新使用手册
- 🔧 问题反馈：通过系统内置反馈功能

### 社区资源
- GitHub仓库：查看源代码和问题跟踪
- 用户手册：详细的操作说明和最佳实践
- 技术博客：深入的技术分析和使用案例

---

*本手册将随着系统功能更新而持续完善，建议定期查看最新版本。*