### 规则系统使用指南（DSL 与兼容模式对比、用法详解）

本文档说明平台两套规则写法的区别与用法，并给出可直接粘贴的示例。推荐优先使用 DSL 规则；若需要正则表达式再使用兼容模式（patterns/operator/is_regex）。

---

### 1. 两套规则引擎的区别
- **DSL（推荐）**
  - 语法：`|`（或）、`&`（与）、`!`/`！`（非）、括号`( )`、引号短语`"..."`。
  - 单位：逐行匹配，只有“同一行”满足表达式才算命中。
  - 匹配：引号短语为大小写不敏感的普通子串（非正则）。
  - 适合：需要表达“同一行内”词语组合关系（函数名 + 模块名/网卡名等）。

- **兼容模式（patterns + operator + is_regex）**
  - 语法：关键字/正则列表 + 组合方式（`OR`/`AND`/`NOT`）。
  - 单位：对整段内容求并/交/差，不强制同行（`AND` 仅要求各模式在文档任意位置至少出现一次）。
  - 匹配：`is_regex=true` 时每条 pattern 当作正则，否则当作普通子串。
  - 适合：历史规则、必须用正则的复杂模式、对“同行共现”没有约束的场景。

> 同时填写 DSL 与 patterns 时，系统优先使用 DSL。若仅填了单行且带运算符的 patterns，系统会自动把它当作 DSL 解析（兼容快捷写法）。

---

### 2. 示例对比（以 Atlantic 网卡崩溃为例）
- **DSL（推荐）**
```
"aq_ring_rx_clean" & "atlantic"
```
含义：同行同时包含 `aq_ring_rx_clean` 与 `atlantic` 才命中（大小写不敏感）。

- **兼容模式 OR**（过宽泛，不建议）
```
patterns: ["aq_ring_rx_clean", "atlantic"], operator: "OR", is_regex: false
```
任一出现即命中，容易误报。

- **兼容模式 AND**（不要求同行，容易误把不相关位置当作关联）
```
patterns: ["aq_ring_rx_clean", "atlantic"], operator: "AND", is_regex: false
```
只要两者出现在文档的任意位置即命中，缺少“同行共现”的约束。

> 结论：需要“同行共现”时请选择 DSL，误报少、语义清晰。

---

### 3. DSL 语法速查
- 基本：
  - `A | B`：A 或 B
  - `A & B`：A 与 B（同行同时满足）
  - `!A` 或 `！A`：非 A（同行不包含 A）
  - `( ... )`：分组与优先级
  - `"短语"`：短语子串（大小写不敏感；可含空格；非正则）
- 优先级：`!` > `&` > `|`（可用括号明确）
- 隐式与：相邻的短语/分组会自动插入 `&`，但建议显式写出便于阅读。

---

### 4. 常用 DSL 模板
- 任一匹配（或）
```
"kernel panic" | "segmentation fault"
```
- 同时匹配（与）
```
"Out of memory" & "kill"
```
- 组合优先级（与 + 或）
```
"atlantic" & ( "aq_ring_rx_clean" | "aq_ring_update_queue_state" )
```
- 排除（非）
```
"kernel panic" & !"soft lockup"
```
- 中文“非”
```
"内核崩溃" ！"测试环境"
```
- 复杂示例：包含 panic 且同行包含 BUG 或 Oops，但不包含 probe
```
"panic" & ( "BUG" | "Oops" ) & !"probe"
```

---

### 5. 兼容模式写法与速查
- 字段：
  - `patterns`（字符串数组）
  - `operator`：`OR | AND | NOT`
  - `is_regex`：`true | false`
- 示例：
  - OR：`patterns: ["A","B"], operator: "OR"`
  - AND：`patterns: ["A","B"], operator: "AND"`
  - NOT：`patterns: ["A"], operator: "NOT"`（所有模式均不出现才命中）
- 何时用兼容模式：
  - 必须使用正则表达式；
  - 判定无需“同行共现”。

---

### 6. 实战：Atlantic 规则的可扩展版本
- 允许另一个函数名也触发：
```
"atlantic" & ( "aq_ring_rx_clean" | "aq_ring_update_queue_state" )
```
- 排除探测阶段日志：
```
"atlantic" & "aq_ring_rx_clean" & !"probe"
```
- 模块名/标签多备选：
```
("atlantic" | "[atlantic]") & "aq_ring_rx_clean"
```
- 监控 Atlantic 错误关键字集合：
```
"atlantic" & ( "panic" | "BUG" | "Oops" )
```

---

### 7. 最佳实践
- 需要“同行语义”时优先选 DSL；
- 短语尽量精确（函数名、模块名、显著关键词）；
- 有空格的词必须加引号：`"kernel panic"`；
- 有排除条件时用 `!`/`！`；
- 真正需要正则时再用兼容模式并开启 `is_regex=true`；
- DSL 为大小写不敏感，无需写大小写变体。

---

### 8. 调试与验证
- UI：规则弹窗中编写 DSL 后，使用“文本分析”快速验证命中行与上下文；
- API：`/api/test-dsl?rule=...&text=...`（需携带 Bearer Token），可返回是否匹配及命中位置；
- 详情页：命中将按“问题类型（规则名）”聚合，自动置顶“最新错误”。

---

### 9. 迁移参考（从兼容模式迁到 DSL）
- 兼容 AND：`patterns: ["kernel panic","atlantic"], operator: "AND"`
- 推荐 DSL：`"kernel panic" & "atlantic"`
- 兼容 NOT：`patterns: ["test"], operator: "NOT"`
- 推荐 DSL：`!"test"`

---

### 10. 性能说明（简要）
- DSL：逐行分割 + 表达式编译缓存（AST），同行求值；
- 兼容 OR：规则引擎会合并为一次正则扫描；
- 建议：
  - 优先 DSL 或 `is_regex=false` 的关键字；
  - 仅在需要时使用复杂正则；
  - 对非常长的日志使用分片预览与后台分析（系统已内置）。

---

### 11. 附：可直接粘贴的 DSL 片段（Atlantic 专题）
```
# 1) 基础命中：函数 + 模块
"aq_ring_rx_clean" & "atlantic"

# 2) 多函数备选
"atlantic" & ( "aq_ring_rx_clean" | "aq_ring_update_queue_state" )

# 3) 排除探测阶段
"atlantic" & "aq_ring_rx_clean" & !"probe"

# 4) 模块名备选
("atlantic" | "[atlantic]") & "aq_ring_rx_clean"

# 5) 常见致命关键字集合
"atlantic" & ( "panic" | "BUG" | "Oops" )
```

> 如需基于你的真实日志做一份“贴合业务”的规则清单（含排除项与权重排序），把几行匿名样例日志发我即可生成。 