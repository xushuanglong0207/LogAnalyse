<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êó•ÂøóÂàÜÊûêÂ∑•ÂÖ∑</title>
    <link rel="stylesheet" href="https://unpkg.com/antd@5.12.0/dist/reset.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
        }

        .logo-icon {
            font-size: 24px;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-content {
            flex: 1;
            padding: 24px;
        }

        .tabs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-header {
            display: flex;
            background: #fafafa;
            border-bottom: 1px solid #e8e8e8;
        }

        .tab-button {
            flex: 1;
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .tab-button:hover {
            background: #f0f0f0;
        }

        .tab-content {
            padding: 32px;
            min-height: 500px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #666;
            margin-bottom: 32px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .feature-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .feature-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .feature-desc {
            color: #666;
            line-height: 1.6;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            margin: 8px;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .upload-area {
            border: 2px dashed #d9d9d9;
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-icon {
            font-size: 64px;
            color: #d9d9d9;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 14px;
            color: #999;
        }

        .hidden {
            display: none !important;
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        /* Ê∑±Ëâ≤Ê®°ÂºèÊ†∑Âºè */
        .dark-theme {
            background-color: #1a1a1a;
            color: #e8e8e8;
        }

        .dark-theme .header {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }

        .dark-theme .nav-tabs {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }

        .dark-theme .nav-tab {
            background: #2d2d2d;
            color: #e8e8e8;
            border-color: #404040;
        }

        .dark-theme .nav-tab.active {
            background: #1a1a1a;
            color: #1890ff;
        }

        .dark-theme .main-content {
            background: #1a1a1a;
        }

        .dark-theme .upload-area {
            background: #2d2d2d;
            border-color: #404040;
        }

        .dark-theme .upload-area.dragover {
            background: #404040;
            border-color: #1890ff;
        }

        .dark-theme .btn {
            background: #2d2d2d;
            color: #e8e8e8;
            border-color: #404040;
        }

        .dark-theme .btn:hover {
            background: #404040;
        }

        .dark-theme .btn-primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .dark-theme .modal-content {
            background: #2d2d2d;
            color: #e8e8e8;
        }

        .dark-theme .modal-header,
        .dark-theme .modal-footer {
            border-color: #404040;
        }

        .dark-theme .form-group input,
        .dark-theme .form-group select,
        .dark-theme .form-group textarea {
            background: #1a1a1a;
            color: #e8e8e8;
            border-color: #404040;
        }

        .dark-theme .message {
            background: #2d2d2d;
            border-color: #404040;
        }

        .dark-theme .message.success {
            background: #1f5f1f;
            border-color: #52c41a;
        }

        .dark-theme .message.error {
            background: #5f1f1f;
            border-color: #ff4d4f;
        }

        .dark-theme .message.warning {
            background: #5f4f1f;
            border-color: #faad14;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #52c41a;
        }

        .status-error {
            background: #ff4d4f;
        }

        .status-warning {
            background: #faad14;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Â§¥ÈÉ® -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üìä</span>
                <span>Êó•ÂøóÂàÜÊûêÂ∑•ÂÖ∑</span>
                <span style="font-size: 12px; opacity: 0.8;">v1.0.0</span>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                üåô Ê∑±Ëâ≤Ê®°Âºè
            </button>
        </header>

        <!-- ‰∏ªÂÜÖÂÆπ -->
        <main class="main-content">
            <div class="tabs-container">
                <!-- Tab Â§¥ÈÉ® -->
                <div class="tab-header">
                    <button class="tab-button active" onclick="switchTab('home')">
                        üè† È¶ñÈ°µ
                    </button>
                    <button class="tab-button" onclick="switchTab('single')">
                        üìÑ Âçï‰∏™ÂàÜÊûê
                    </button>
                    <button class="tab-button" onclick="switchTab('bulk')">
                        üìÅ ÂÖ®ÈáèÂàÜÊûê
                    </button>
                    <button class="tab-button" onclick="switchTab('rules')">
                        üìã ËßÑÂàôÁÆ°ÁêÜ
                    </button>
                    <button class="tab-button" onclick="switchTab('report')">
                        üìä ÂàÜÊûêÊä•Âëä
                    </button>
                    <button class="tab-button" onclick="switchTab('settings')">
                        ‚öôÔ∏è ËÆæÁΩÆ
                    </button>
                </div>

                <!-- Tab ÂÜÖÂÆπ -->
                <div class="tab-content">
                    <!-- È¶ñÈ°µ -->
                    <div id="home-page" class="tab-page">
                        <h1 class="page-title">Ê¨¢Ëøé‰ΩøÁî®Êó•ÂøóÂàÜÊûêÂ∑•ÂÖ∑</h1>
                        <p class="page-subtitle">Ê°åÈù¢Á´ØÊó•ÂøóÂàÜÊûêÂ∑•ÂÖ∑ - ÊîØÊåÅÊú¨Âú∞ÂíåÊúçÂä°Á´ØËßÑÂàôÂêåÊ≠•ÔºåÂéãÁº©ÂåÖÂÖ®ÈáèÂàÜÊûê</p>

                        <div class="feature-grid">
                            <div class="feature-card" onclick="switchTab('single')">
                                <div class="feature-icon">üìÑ</div>
                                <div class="feature-title">Âçï‰∏™Êó•ÂøóÂàÜÊûê</div>
                                <div class="feature-desc">ÈÄâÊã©Âçï‰∏™Êó•ÂøóÊñá‰ª∂ËøõË°åÂàÜÊûêÔºåÂø´ÈÄüÂÆö‰ΩçÈóÆÈ¢ò</div>
                            </div>

                            <div class="feature-card" onclick="switchTab('bulk')">
                                <div class="feature-icon">üìÅ</div>
                                <div class="feature-title">ÂÖ®ÈáèÂéãÁº©ÂåÖÂàÜÊûê</div>
                                <div class="feature-desc">‰∏ä‰º†Êó•ÂøóÂéãÁº©ÂåÖÔºåËá™Âä®Ëß£ÂéãÂπ∂ÂàÜÊûêÊâÄÊúâÊó•ÂøóÊñá‰ª∂</div>
                            </div>

                            <div class="feature-card" onclick="switchTab('rules')">
                                <div class="feature-icon">üìã</div>
                                <div class="feature-title">ËßÑÂàôÁÆ°ÁêÜ</div>
                                <div class="feature-desc">ÁÆ°ÁêÜÊú¨Âú∞ËßÑÂàôÔºå‰∏éÊúçÂä°Á´ØÂèåÂêëÂêåÊ≠•</div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 32px;">
                            <button class="btn" onclick="switchTab('single')">ÂºÄÂßãÂàÜÊûê</button>
                            <button class="btn btn-secondary" onclick="switchTab('settings')">Êü•ÁúãËÆæÁΩÆ</button>
                        </div>
                    </div>

                    <!-- Âçï‰∏™ÂàÜÊûêÈ°µÈù¢ -->
                    <div id="single-page" class="tab-page hidden">
                        <h1 class="page-title">Âçï‰∏™Êó•ÂøóÂàÜÊûê</h1>
                        <p class="page-subtitle">ÈÄâÊã©Âçï‰∏™Êó•ÂøóÊñá‰ª∂ËøõË°åÂàÜÊûê</p>

                        <div class="upload-area" onclick="selectSingleFile()">
                            <div class="upload-icon">üìÑ</div>
                            <div class="upload-text">ÁÇπÂáªÈÄâÊã©Êó•ÂøóÊñá‰ª∂</div>
                            <div class="upload-hint">ÊîØÊåÅ .log, .txt Á≠âÊ†ºÂºè</div>
                        </div>

                        <!-- ËßÑÂàôÈÄâÊã© -->
                        <div style="margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">ËßÑÂàôÈÄâÊã©</h3>
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="ruleSource" value="local" checked onchange="updateRuleSource('local')">
                                    <span>‰ΩøÁî®Êú¨Âú∞ËßÑÂàô</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="ruleSource" value="server" onchange="updateRuleSource('server')">
                                    <span>‰ΩøÁî®ÊúçÂä°Á´ØËßÑÂàô</span>
                                </label>
                            </div>
                            <div id="rule-status" style="margin-top: 8px; font-size: 12px; color: #666;">
                                ÂΩìÂâç‰ΩøÁî®Êú¨Âú∞ËßÑÂàôÔºåÊó†ÈúÄËøûÊé•ÊúçÂä°Á´Ø
                            </div>
                        </div>

                        <div style="margin-top: 24px; text-align: center;">
                            <button class="btn" onclick="selectSingleFile()">ÈÄâÊã©Êñá‰ª∂</button>
                            <button class="btn btn-primary" onclick="startSingleAnalysis()" id="single-analyze-btn">ÂºÄÂßãÂàÜÊûê</button>
                            <button class="btn btn-secondary" onclick="stopAnalysis()" id="single-stop-btn" style="display: none;">ÂÅúÊ≠¢ÂàÜÊûê</button>
                        </div>
                    </div>

                    <!-- ÂÖ®ÈáèÂàÜÊûêÈ°µÈù¢ -->
                    <div id="bulk-page" class="tab-page hidden">
                        <h1 class="page-title">ÂÖ®ÈáèÂéãÁº©ÂåÖÂàÜÊûê</h1>
                        <p class="page-subtitle">‰∏ä‰º†Êó•ÂøóÂéãÁº©ÂåÖÔºåËá™Âä®Ëß£ÂéãÂπ∂ÂàÜÊûêÊâÄÊúâÊó•ÂøóÊñá‰ª∂</p>

                        <div class="upload-area" onclick="selectBulkFile()">
                            <div class="upload-icon">üìÅ</div>
                            <div class="upload-text">ÁÇπÂáªÈÄâÊã©ÂéãÁº©ÂåÖ</div>
                            <div class="upload-hint">ÊîØÊåÅ .zip, .tar, .gz, .tgz Á≠âÊ†ºÂºè</div>
                        </div>

                        <!-- ËßÑÂàôÈÄâÊã© -->
                        <div style="margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">ËßÑÂàôÈÄâÊã©</h3>
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkRuleSource" value="local" checked onchange="updateRuleSource('local')">
                                    <span>‰ΩøÁî®Êú¨Âú∞ËßÑÂàô</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkRuleSource" value="server" onchange="updateRuleSource('server')">
                                    <span>‰ΩøÁî®ÊúçÂä°Á´ØËßÑÂàô</span>
                                </label>
                            </div>
                            <div id="bulk-rule-status" style="margin-top: 8px; font-size: 12px; color: #666;">
                                ÂΩìÂâç‰ΩøÁî®Êú¨Âú∞ËßÑÂàôÔºåÊó†ÈúÄËøûÊé•ÊúçÂä°Á´Ø
                            </div>
                        </div>

                        <div style="margin-top: 24px; text-align: center;">
                            <button class="btn" onclick="selectBulkFile()">ÈÄâÊã©ÂéãÁº©ÂåÖ</button>
                            <button class="btn btn-primary" onclick="startBulkAnalysis()" id="bulk-analyze-btn">ÂºÄÂßãÂàÜÊûê</button>
                            <button class="btn btn-secondary" onclick="stopAnalysis()" id="bulk-stop-btn" style="display: none;">ÂÅúÊ≠¢ÂàÜÊûê</button>
                        </div>
                    </div>

                    <!-- ËßÑÂàôÁÆ°ÁêÜÈ°µÈù¢ -->
                    <div id="rules-page" class="tab-page hidden">
                        <h1 class="page-title">ËßÑÂàôÁÆ°ÁêÜ</h1>
                        <p class="page-subtitle">ÁÆ°ÁêÜÊú¨Âú∞ËßÑÂàôÔºå‰∏éÊúçÂä°Á´ØÂèåÂêëÂêåÊ≠•</p>

                        <div style="margin-bottom: 24px;">
                            <button class="btn" onclick="syncRules()">ÂêåÊ≠•ËßÑÂàô</button>
                            <button class="btn btn-secondary" onclick="addRule()">Ê∑ªÂä†ËßÑÂàô</button>
                            <button class="btn btn-secondary" onclick="exportRules()">ÂØºÂá∫ËßÑÂàô</button>
                        </div>

                        <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
                            <h3>ËßÑÂàôÂàóË°®</h3>
                            <div id="rules-list">
                                <!-- ËßÑÂàôÂàóË°®Â∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->
                            </div>
                        </div>

                        <!-- ËßÑÂàôÁºñËæëÊ®°ÊÄÅÊ°Ü -->
                        <div id="rule-modal" class="modal hidden">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 id="rule-modal-title">ÁºñËæëËßÑÂàô</h3>
                                    <button class="modal-close" onclick="closeRuleModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <form id="rule-form">
                                        <div class="form-group">
                                            <label for="rule-name">ËßÑÂàôÂêçÁß∞:</label>
                                            <input type="text" id="rule-name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-description">ËßÑÂàôÊèèËø∞:</label>
                                            <textarea id="rule-description" rows="2"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-pattern">ÂåπÈÖçÊ®°Âºè:</label>
                                            <input type="text" id="rule-pattern" required placeholder="ERROR|error|Error">
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-type">ËßÑÂàôÁ±ªÂûã:</label>
                                            <select id="rule-type">
                                                <option value="regex">Ê≠£ÂàôË°®ËææÂºè</option>
                                                <option value="keyword">ÂÖ≥ÈîÆÂ≠ó</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-problem-type">ÈóÆÈ¢òÁ±ªÂûã:</label>
                                            <input type="text" id="rule-problem-type" placeholder="error">
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-problem-description">ÈóÆÈ¢òÊèèËø∞:</label>
                                            <textarea id="rule-problem-description" rows="2"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                <input type="checkbox" id="rule-active" checked>
                                                ÂêØÁî®ËßÑÂàô
                                            </label>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" onclick="closeRuleModal()">ÂèñÊ∂à</button>
                                    <button class="btn btn-primary" onclick="saveRule()">‰øùÂ≠ò</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÂàÜÊûêÊä•ÂëäÈ°µÈù¢ -->
                    <div id="report-page" class="tab-page hidden">
                        <h1 class="page-title">ÂàÜÊûêÊä•Âëä</h1>
                        <p class="page-subtitle">Êü•ÁúãÂéÜÂè≤ÂàÜÊûêÊä•ÂëäÂíåÁªìÊûú</p>

                        <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
                            <h3>ÊúÄËøëÁöÑÂàÜÊûêÊä•Âëä</h3>
                            <p style="color: #666; margin-top: 16px;">ÊöÇÊó†ÂàÜÊûêÊä•ÂëäÔºåËØ∑ÂÖàËøõË°åÊó•ÂøóÂàÜÊûê</p>
                        </div>
                    </div>

                    <!-- ËÆæÁΩÆÈ°µÈù¢ -->
                    <div id="settings-page" class="tab-page hidden">
                        <h1 class="page-title">ËÆæÁΩÆ</h1>
                        <p class="page-subtitle">ÈÖçÁΩÆÂ∫îÁî®ËÆæÁΩÆÂíåÂÅèÂ•Ω</p>

                        <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
                            <h3>Â∫îÁî®ËÆæÁΩÆ</h3>
                            <div style="margin: 16px 0;">
                                <label style="display: block; margin-bottom: 8px;">ÊúçÂä°Á´ØÂú∞ÂùÄ:</label>
                                <input type="text" id="serverUrl" placeholder="http://localhost:8001" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <small style="color: #666;">Áî®‰∫éËßÑÂàôÂêåÊ≠•ÂíåËøúÁ®ãÂàÜÊûê</small>
                            </div>
                            <div style="margin: 16px 0;">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" id="autoSync" style="margin-right: 8px;">
                                    Ëá™Âä®ÂêåÊ≠•ËßÑÂàô
                                </label>
                                <small style="color: #666;">ÂêØÂä®Êó∂Ëá™Âä®‰ªéÊúçÂä°Á´ØÂêåÊ≠•ËßÑÂàô</small>
                            </div>
                            <div style="margin: 16px 0;">
                                <button class="btn" onclick="saveAppSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
                                <button class="btn btn-secondary" onclick="testConnection()">ÊµãËØïËøûÊé•</button>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; padding: 24px; border-radius: 8px; margin-top: 24px;">
                            <h3>ÂÖ≥‰∫é</h3>
                            <p>Êó•ÂøóÂàÜÊûêÂ∑•ÂÖ∑ v1.0.0</p>
                            <p>ÊîØÊåÅÊú¨Âú∞ÂíåÊúçÂä°Á´ØËßÑÂàôÂêåÊ≠•ÔºåÂéãÁº©ÂåÖÂÖ®ÈáèÂàÜÊûê</p>
                            <div style="margin-top: 16px;">
                                <button class="btn btn-secondary" onclick="clearAllData()">Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Tab ÂàáÊç¢ÂäüËÉΩ
        function switchTab(tabName) {
            // ÈöêËóèÊâÄÊúâÈ°µÈù¢
            const pages = document.querySelectorAll('.tab-page');
            pages.forEach(page => page.classList.add('hidden'));

            // ÁßªÈô§ÊâÄÊúâÊåâÈíÆÁöÑ active Áä∂ÊÄÅ
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // ÊòæÁ§∫ÁõÆÊ†áÈ°µÈù¢
            const targetPage = document.getElementById(tabName + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            // ÊøÄÊ¥ªÂØπÂ∫îÊåâÈíÆ
            const targetButton = event?.target || document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }

        // ‰∏ªÈ¢òÂàáÊç¢
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-theme');

            if (isDark) {
                body.classList.remove('dark-theme');
                document.querySelector('.theme-toggle').textContent = 'üåô Ê∑±Ëâ≤Ê®°Âºè';
            } else {
                body.classList.add('dark-theme');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè';
            }
        }

        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let selectedFile = null;
        let selectedBulkFile = null;
        let currentRules = [];
        let analysisController = null; // Áî®‰∫éÂÅúÊ≠¢ÂàÜÊûê
        let settings = {
            serverUrl: 'http://localhost:8001',
            autoSync: true,
            useLocalRules: true // ÈªòËÆ§‰ΩøÁî®Êú¨Âú∞ËßÑÂàô
        };

        // ËßÑËåÉÂåñ‰∏é‰øÆÂ§çÂéÜÂè≤ËÆæÁΩÆÔºàÁ´ØÂè£/URLÁ≠âÔºâ
        function sanitizeSettings() {
            try {
                if (typeof settings.serverUrl === 'string') {
                    // ÂéªÊéâÂ∞æÈÉ®ÊñúÊù†
                    settings.serverUrl = settings.serverUrl.replace(/\/$/, '');
                    // Â∞ÜÂéÜÂè≤ÈÅóÁïôÁöÑ 8080 Á´ØÂè£ËøÅÁßªÂà∞ 8001
                    if (settings.serverUrl.includes('localhost:8080')) {
                        settings.serverUrl = settings.serverUrl.replace('localhost:8080', 'localhost:8001');
                    }
                    if (settings.serverUrl.includes('127.0.0.1:8080')) {
                        settings.serverUrl = settings.serverUrl.replace('127.0.0.1:8080', '127.0.0.1:8001');
                    }
                }
            } catch (e) {
                console.warn('sanitizeSettings Â§±Ë¥•:', e);
            }
        }

        // ‰ªéÁïåÈù¢ËØªÂèñÂΩìÂâçËßÑÂàôÊ∫êÔºàÂçïÈÄâÊ°Ü‰∏∫ÂáÜÔºâ
        function getUISelectedRuleSource(forBulk = false) {
            const name = forBulk ? 'bulkRuleSource' : 'ruleSource';
            const checked = document.querySelector(`input[name="${name}"]:checked`);
            return checked ? checked.value : (settings.useLocalRules ? 'local' : 'server');
        }

        // ÂºÇÊ≠•ËÆ©Âá∫ÔºàÈÅøÂÖçÈïøÊó∂Èó¥ÈòªÂ°ûUIÔºâ
        function pause(ms = 0) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }



        // Âä†ËΩΩËÆæÁΩÆ
        function loadSettings() {
            try {
                const saved = localStorage.getItem('logAnalyzerSettings');
                if (saved) {
                    settings = { ...settings, ...JSON.parse(saved) };
                }
                // Áªü‰∏Ä‰øÆÂ§çÂéÜÂè≤URL‰∏éÁ´ØÂè£
                sanitizeSettings();
                updateSettingsUI();
            } catch (e) {
                console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', e);
            }
        }

        // ‰øùÂ≠òËÆæÁΩÆ
        function saveSettings() {
            try {
                localStorage.setItem('logAnalyzerSettings', JSON.stringify(settings));
                showMessage('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
            } catch (e) {
                console.error('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•:', e);
                showMessage('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•', 'error');
            }
        }

        // Êõ¥Êñ∞ËÆæÁΩÆÁïåÈù¢
        function updateSettingsUI() {
            const serverUrlInput = document.getElementById('serverUrl');
            const autoSyncCheckbox = document.getElementById('autoSync');
            if (serverUrlInput) serverUrlInput.value = settings.serverUrl;
            if (autoSyncCheckbox) autoSyncCheckbox.checked = settings.autoSync;
        }

        // ÊòæÁ§∫Ê∂àÊÅØÔºàÂéªÈáç + Âçï‰æã + ËäÇÊµÅÔºåÈò≤Ê≠¢Âà∑Â±èÂç°È°øÔºâ
        function showMessage(message, type = 'info') {
            try {
                const now = Date.now();
                const isProgress = /Ê≠£Âú®ÂàÜÊûê|ÂºÄÂßãËß£Âéã|Ê≠£Âú®ÊµãËØïËøûÊé•|Ê≠£Âú®ÂêåÊ≠•ËßÑÂàô/.test(message);
                const duration = type === 'info' ? (isProgress ? 800 : 1500) : 3000;

                // ÂÖ®Â±ÄÂçï‰æãÂÖÉÁ¥†
                if (!window.__toastEl) {
                    const el = document.createElement('div');
                    el.id = 'global-toast';
                    el.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 12px 24px;
                        border-radius: 6px;
                        color: white;
                        font-weight: 500;
                        z-index: 10000;
                        max-width: 60vw;
                        pointer-events: none;
                        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                    `;
                    document.body.appendChild(el);
                    window.__toastEl = el;
                }

                const el = window.__toastEl;

                // ËäÇÊµÅÔºö500ms ÂÜÖÈáçÂ§ç info ÊèêÁ§∫Áõ¥Êé•Êõ¥Êñ∞ÊñáÊú¨‰∏çÈáçÊéí
                if (type === 'info' && window.__lastToastTime && (now - window.__lastToastTime) < 500) {
                    el.textContent = message;
                } else {
                    // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÈ¢úËâ≤
                    switch (type) {
                        case 'success':
                            el.style.background = '#52c41a';
                            break;
                        case 'error':
                            el.style.background = '#ff4d4f';
                            break;
                        case 'warning':
                            el.style.background = '#faad14';
                            break;
                        default:
                            el.style.background = '#1890ff';
                    }
                    el.textContent = message;
                }

                el.style.display = 'block';
                window.__lastToastTime = now;

                // ÈáçÁΩÆËÆ°Êó∂Âô®ÔºöÂè™‰øùÁïô‰∏Ä‰∏™ÂÆöÊó∂Âô®
                if (window.__toastTimer) clearTimeout(window.__toastTimer);
                window.__toastTimer = setTimeout(() => {
                    el.style.display = 'none';
                }, duration);
            } catch (e) {
                console.warn('showMessage fallback:', e);
                alert(message);
            }
        }

        // Êñá‰ª∂ÈÄâÊã©ÂäüËÉΩ
        function selectSingleFile() {
            if (window.require) {
                const { ipcRenderer } = window.require('electron');
                ipcRenderer.invoke('select-file', {
                    filters: [
                        { name: 'Êó•ÂøóÊñá‰ª∂', extensions: ['log', 'txt', 'out', 'syslog', 'kern', 'auth', 'messages', 'dmesg', 'access', 'error'] },
                        { name: 'ÊâÄÊúâÊñá‰ª∂', extensions: ['*'] }
                    ]
                }).then(result => {
                    if (!result.canceled && result.filePaths.length > 0) {
                        selectedFile = result.filePaths[0];
                        updateSingleFileUI();
                        showMessage('Â∑≤ÈÄâÊã©Êñá‰ª∂: ' + selectedFile.split('\\').pop(), 'success');
                    }
                });
            } else {
                showMessage('ËØ∑Âú® Electron ÁéØÂ¢É‰∏≠‰ΩøÁî®Ê≠§ÂäüËÉΩ', 'error');
            }
        }

        function selectBulkFile() {
            if (window.require) {
                const { ipcRenderer } = window.require('electron');
                ipcRenderer.invoke('select-file', {
                    filters: [
                        { name: 'ÂéãÁº©Êñá‰ª∂', extensions: ['zip', 'rar', '7z', 'tar', 'gz', 'tgz'] },
                        { name: 'ÊâÄÊúâÊñá‰ª∂', extensions: ['*'] }
                    ]
                }).then(result => {
                    if (!result.canceled && result.filePaths.length > 0) {
                        selectedBulkFile = result.filePaths[0];
                        updateBulkFileUI();
                        showMessage('Â∑≤ÈÄâÊã©ÂéãÁº©ÂåÖ: ' + selectedBulkFile.split('\\').pop(), 'success');
                    }
                });
            } else {
                showMessage('ËØ∑Âú® Electron ÁéØÂ¢É‰∏≠‰ΩøÁî®Ê≠§ÂäüËÉΩ', 'error');
            }
        }

        // Êõ¥Êñ∞Êñá‰ª∂ÈÄâÊã©ÁïåÈù¢
        function updateSingleFileUI() {
            const uploadArea = document.querySelector('#single-page .upload-area');
            if (uploadArea && selectedFile) {
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <div class="upload-text">Â∑≤ÈÄâÊã©: ${selectedFile.split('\\').pop()}</div>
                    <div class="upload-hint">ÁÇπÂáªÈáçÊñ∞ÈÄâÊã©Êñá‰ª∂</div>
                `;
            }
        }

        function updateBulkFileUI() {
            const uploadArea = document.querySelector('#bulk-page .upload-area');
            if (uploadArea && selectedBulkFile) {
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <div class="upload-text">Â∑≤ÈÄâÊã©: ${selectedBulkFile.split('\\').pop()}</div>
                    <div class="upload-hint">ÁÇπÂáªÈáçÊñ∞ÈÄâÊã©ÂéãÁº©ÂåÖ</div>
                `;
            }
        }

        // ËßÑÂàôÊ∫êÈÄâÊã©
        function updateRuleSource(source) {
            settings.useLocalRules = (source === 'local');

            // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
            const statusElements = ['rule-status', 'bulk-rule-status'];
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (source === 'local') {
                        element.textContent = 'ÂΩìÂâç‰ΩøÁî®Êú¨Âú∞ËßÑÂàôÔºåÊó†ÈúÄËøûÊé•ÊúçÂä°Á´Ø';
                        element.style.color = '#52c41a';
                    } else {
                        element.textContent = 'ÂΩìÂâç‰ΩøÁî®ÊúçÂä°Á´ØËßÑÂàôÔºåÈúÄË¶ÅÁΩëÁªúËøûÊé•';
                        element.style.color = '#fa8c16';
                    }
                }
            });

            // ‰øùÂ≠òËÆæÁΩÆ
            localStorage.setItem('logAnalyzerSettings', JSON.stringify(settings));
            showMessage(`Â∑≤ÂàáÊç¢Âà∞${source === 'local' ? 'Êú¨Âú∞' : 'ÊúçÂä°Á´Ø'}ËßÑÂàô`, 'success');
        }

        // ÂÅúÊ≠¢ÂàÜÊûê
        function stopAnalysis() {
            if (analysisController) {
                analysisController.abort();
                analysisController = null;
            }

            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            const analyzeButtons = ['single-analyze-btn', 'bulk-analyze-btn'];
            const stopButtons = ['single-stop-btn', 'bulk-stop-btn'];

            analyzeButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.style.display = 'inline-block';
                    btn.disabled = false;
                }
            });

            stopButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.style.display = 'none';
            });

            showMessage('ÂàÜÊûêÂ∑≤ÂÅúÊ≠¢', 'info');
        }

        // ÂàÜÊûêÂäüËÉΩ
        async function startSingleAnalysis() {
            if (!selectedFile) {
                showMessage('ËØ∑ÂÖàÈÄâÊã©Êó•ÂøóÊñá‰ª∂', 'warning');
                return;
            }

            try {
                // ÂàõÂª∫‰∏≠Êñ≠ÊéßÂà∂Âô®
                analysisController = new AbortController();

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                document.getElementById('single-analyze-btn').style.display = 'none';
                document.getElementById('single-stop-btn').style.display = 'inline-block';

                showMessage('ÂºÄÂßãÂàÜÊûêÊó•ÂøóÊñá‰ª∂...', 'info');

                // Ê£ÄÊü• Electron ÁéØÂ¢É
                if (!window.require) {
                    throw new Error('ËØ∑Âú® Electron ÁéØÂ¢É‰∏≠ËøêË°åÊ≠§Â∫îÁî®');
                }

                // ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
                const fs = window.require('fs');
                const path = window.require('path');

                console.log('ËØªÂèñÊñá‰ª∂:', selectedFile);
                const content = fs.readFileSync(selectedFile, 'utf8');
                const filename = path.basename(selectedFile);
                console.log('Êñá‰ª∂ËØªÂèñÊàêÂäüÔºåÊñá‰ª∂Âêç:', filename, 'ÂÜÖÂÆπÈïøÂ∫¶:', content.length);

                // Ê†πÊçÆ‚ÄúÁïåÈù¢ÂçïÈÄâÊ°Ü‚ÄùÈÄâÊã©ÂàÜÊûêÊñπÂºèÔºåÈÅøÂÖçËÆæÁΩÆ‰∏éUI‰∏ç‰∏ÄËá¥
                const uiSource = getUISelectedRuleSource(false);
                settings.useLocalRules = (uiSource === 'local');
                console.log('‰ΩøÁî®ËßÑÂàôÊ∫ê:', uiSource, 'useLocalRules:', settings.useLocalRules);

                let result;
                if (settings.useLocalRules) {
                    console.log('‰ΩøÁî®Êú¨Âú∞ËßÑÂàôÂàÜÊûê');
                    result = await analyzeLogContent(content, filename);
                } else {
                    console.log('‰ΩøÁî®ÊúçÂä°Á´ØËßÑÂàôÂàÜÊûê');
                    result = await analyzeWithServerRules(content, filename);
                }

                // Ê£ÄÊü•ÊòØÂê¶Ë¢´‰∏≠Êñ≠
                if (analysisController.signal.aborted) {
                    console.log('ÂàÜÊûêË¢´‰∏≠Êñ≠');
                    return;
                }

                console.log('ÂàÜÊûêÁªìÊûú:', result);

                // ÊòæÁ§∫ÁªìÊûú
                showAnalysisResult(result);
                switchTab('report');
                showMessage('ÂàÜÊûêÂÆåÊàê', 'success');

            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('ÂàÜÊûêÂ∑≤Ë¢´Áî®Êà∑ÂÅúÊ≠¢', 'info');
                    return;
                }
                console.error('ÂàÜÊûêÂ§±Ë¥•:', error);
                showMessage('ÂàÜÊûêÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                document.getElementById('single-analyze-btn').style.display = 'inline-block';
                document.getElementById('single-stop-btn').style.display = 'none';
                analysisController = null;
            }
        }

        async function startBulkAnalysis() {
            if (!selectedBulkFile) {
                showMessage('ËØ∑ÂÖàÈÄâÊã©ÂéãÁº©ÂåÖ', 'warning');
                return;
            }

            try {
                // ÂàõÂª∫‰∏≠Êñ≠ÊéßÂà∂Âô®
                analysisController = new AbortController();

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                document.getElementById('bulk-analyze-btn').style.display = 'none';
                document.getElementById('bulk-stop-btn').style.display = 'inline-block';

                showMessage('ÂºÄÂßãËß£ÂéãÂπ∂ÂàÜÊûêÂéãÁº©ÂåÖ...', 'info');

                // Ê£ÄÊü•Êñá‰ª∂Êâ©Â±ïÂêç
                const fileName = selectedBulkFile.toLowerCase();
                const isSupported = fileName.endsWith('.zip') ||
                                  fileName.endsWith('.tar') ||
                                  fileName.endsWith('.gz') ||
                                  fileName.endsWith('.tgz');

                if (!isSupported) {
                    showMessage('ÊöÇ‰∏çÊîØÊåÅÊ≠§ÂéãÁº©Ê†ºÂºèÔºåËØ∑‰ΩøÁî® .zip, .tar, .gz, .tgz Ê†ºÂºè', 'warning');
                    return;
                }

                // Ëß£ÂéãÂπ∂ÂàÜÊûêÔºàÂºÄÂßãÂâç‰ª•ÁïåÈù¢ÂçïÈÄâÊ°Ü‰∏∫ÂáÜÔºâ
                const uiSourceBulk = getUISelectedRuleSource(true);
                settings.useLocalRules = (uiSourceBulk === 'local');

                const result = await extractAndAnalyzeArchive(selectedBulkFile);

                // Ê£ÄÊü•ÊòØÂê¶Ë¢´‰∏≠Êñ≠
                if (analysisController.signal.aborted) {
                    return;
                }

                // ÊòæÁ§∫ÁªìÊûú
                showAnalysisResult(result);
                switchTab('report');

            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('ÂàÜÊûêÂ∑≤Ë¢´Áî®Êà∑ÂÅúÊ≠¢', 'info');
                    return;
                }
                console.error('ÊâπÈáèÂàÜÊûêÂ§±Ë¥•:', error);
                showMessage('ÊâπÈáèÂàÜÊûêÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                document.getElementById('bulk-analyze-btn').style.display = 'inline-block';
                document.getElementById('bulk-stop-btn').style.display = 'none';
                analysisController = null;
            }
        }

        // Ëß£ÂéãÂπ∂ÂàÜÊûêÂéãÁº©ÂåÖ
        async function extractAndAnalyzeArchive(archivePath) {
            const path = window.require('path');
            const fs = window.require('fs');
            const os = window.require('os');
            const { spawn } = window.require('child_process');

            // ÂàõÂª∫‰∏¥Êó∂ÁõÆÂΩï
            const tempDir = path.join(os.tmpdir(), 'log_analyzer_' + Date.now());
            fs.mkdirSync(tempDir, { recursive: true });

            try {
                // Ëß£ÂéãÊñá‰ª∂
                await extractArchive(archivePath, tempDir);

                // Êü•ÊâæÊâÄÊúâÊó•ÂøóÊñá‰ª∂
                const logFiles = findLogFiles(tempDir);

                if (logFiles.length === 0) {
                    throw new Error('ÂéãÁº©ÂåÖ‰∏≠Êú™ÊâæÂà∞Êó•ÂøóÊñá‰ª∂');
                }

                showMessage(`ÊâæÂà∞ ${logFiles.length} ‰∏™Êó•ÂøóÊñá‰ª∂ÔºåÂºÄÂßãÂàÜÊûê...`, 'info');

                // ÂàÜÊûêÊâÄÊúâÊó•ÂøóÊñá‰ª∂
                const allIssues = [];
                let totalLines = 0;

                for (let i = 0; i < logFiles.length; i++) {
                    const logFile = logFiles[i];
                    try {
                        // ÊòæÁ§∫Êñá‰ª∂Á∫ßÂà´ÁöÑËøõÂ∫¶
                        const fileProgress = Math.round(((i + 1) / logFiles.length) * 100);
                        showMessage(`Ê≠£Âú®ÂàÜÊûêÊñá‰ª∂ ${i + 1}/${logFiles.length} (${fileProgress}%)`, 'info');

                        const content = fs.readFileSync(logFile, 'utf8');
                        const fileName = path.relative(tempDir, logFile);

                        const result = await analyzeLogContent(content, fileName);
                        totalLines += result.total_lines;

                        // ‰∏∫ÊØè‰∏™ÈóÆÈ¢òÊ∑ªÂä†Êñá‰ª∂‰ø°ÊÅØ
                        result.issues.forEach(issue => {
                            issue.source_file = fileName;
                            allIssues.push(issue);
                        });

                        // Ê£ÄÊü•ÊòØÂê¶Ë¢´‰∏≠Êñ≠
                        if (analysisController?.signal.aborted) {
                            throw new DOMException('ÂàÜÊûêË¢´‰∏≠Êñ≠', 'AbortError');
                        }

                        // ÊØèÂ§ÑÁêÜÂÆå‰∏Ä‰∏™Êñá‰ª∂ÔºåËÆ©Âá∫‰∏ÄÊ¨°ÔºåÈÅøÂÖçÈïøÊó∂Èó¥ÈòªÂ°û
                        await pause(0);

                    } catch (e) {
                        if (e.name === 'AbortError') {
                            throw e;
                        }
                        console.warn(`ÂàÜÊûêÊñá‰ª∂ ${logFile} Â§±Ë¥•:`, e);
                    }
                }

                return {
                    filename: path.basename(archivePath),
                    total_lines: totalLines,
                    issues_found: allIssues.length,
                    issues: allIssues,
                    analysis_time: new Date().toISOString(),
                    files_analyzed: logFiles.length
                };

            } finally {
                // Ê∏ÖÁêÜ‰∏¥Êó∂ÁõÆÂΩï
                try {
                    fs.rmSync(tempDir, { recursive: true, force: true });
                } catch (e) {
                    console.warn('Ê∏ÖÁêÜ‰∏¥Êó∂ÁõÆÂΩïÂ§±Ë¥•:', e);
                }
            }
        }

        // Ëß£ÂéãÊñá‰ª∂
        function extractArchive(archivePath, outputDir) {
            return new Promise((resolve, reject) => {
                const path = window.require('path');
                const { spawn } = window.require('child_process');

                const fileName = archivePath.toLowerCase();
                let command, args;

                if (fileName.endsWith('.zip')) {
                    // ‰ΩøÁî®PowerShellËß£ÂéãZIPÊñá‰ª∂
                    command = 'powershell';
                    args = ['-Command', `Expand-Archive -Path "${archivePath}" -DestinationPath "${outputDir}" -Force`];
                } else if (fileName.endsWith('.tar') || fileName.endsWith('.tgz') || fileName.endsWith('.tar.gz')) {
                    // ‰ΩøÁî®tarËß£Âéã
                    command = 'tar';
                    args = ['-xf', archivePath, '-C', outputDir];
                } else {
                    reject(new Error('‰∏çÊîØÊåÅÁöÑÂéãÁº©Ê†ºÂºè'));
                    return;
                }

                const process = spawn(command, args);

                process.on('close', (code) => {
                    if (code === 0) {
                        resolve();
                    } else {
                        reject(new Error(`Ëß£ÂéãÂ§±Ë¥•ÔºåÈÄÄÂá∫Á†Å: ${code}`));
                    }
                });

                process.on('error', (error) => {
                    reject(new Error(`Ëß£ÂéãÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•: ${error.message}`));
                });
            });
        }

        // Êü•ÊâæÊó•ÂøóÊñá‰ª∂
        function findLogFiles(dir) {
            const fs = window.require('fs');
            const path = window.require('path');

            const logFiles = [];
            const logExtensions = ['.log', '.txt', '.out', '.err'];

            function scanDirectory(currentDir) {
                try {
                    const items = fs.readdirSync(currentDir);

                    for (const item of items) {
                        const fullPath = path.join(currentDir, item);
                        const stat = fs.statSync(fullPath);

                        if (stat.isDirectory()) {
                            scanDirectory(fullPath);
                        } else if (stat.isFile()) {
                            const ext = path.extname(item).toLowerCase();
                            if (logExtensions.includes(ext) || item.toLowerCase().includes('log')) {
                                logFiles.push(fullPath);
                            }
                        }
                    }
                } catch (e) {
                    console.warn(`Êâ´ÊèèÁõÆÂΩï ${currentDir} Â§±Ë¥•:`, e);
                }
            }

            scanDirectory(dir);
            return logFiles;
        }

        // ÊúçÂä°Á´ØËßÑÂàôÂàÜÊûê
        async function analyzeWithServerRules(content, filename) {
            try {
                const response = await fetch(`${settings.serverUrl}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        filename: filename
                    }),
                    signal: analysisController?.signal
                });

                if (!response.ok) {
                    throw new Error(`ÊúçÂä°Á´ØÂàÜÊûêÂ§±Ë¥•: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw error;
                }
                console.error('ÊúçÂä°Á´ØÂàÜÊûêÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞Êú¨Âú∞ÂàÜÊûê:', error);
                showMessage('ÊúçÂä°Á´ØËøûÊé•Â§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞ËßÑÂàôÂàÜÊûê', 'warning');
                return await analyzeLogContent(content, filename);
            }
        }

        // Êú¨Âú∞Êó•ÂøóÂàÜÊûêÈÄªËæëÔºàÂü∫‰∫éÊúçÂä°Á´ØÈÄªËæëÔºâ
        async function analyzeLogContent(content, filename) {
            try {
                console.log('ÂºÄÂßãÂàÜÊûêÊñá‰ª∂:', filename, 'ÂÜÖÂÆπÈïøÂ∫¶:', content.length);

                if (!content || content.length === 0) {
                    throw new Error('Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫');
                }

                const lines = content.split('\n');
                const issues = [];
                console.log('ÊÄªË°åÊï∞:', lines.length);

                // Ëé∑ÂèñÂΩìÂâçËßÑÂàô
                const rules = await getCurrentRules();
                console.log('Ëé∑ÂèñÂà∞ËßÑÂàôÊï∞Èáè:', rules.length);

                if (!rules || rules.length === 0) {
                    console.warn('Ê≤°ÊúâÂèØÁî®ÁöÑËßÑÂàô');
                    return {
                        filename: filename,
                        total_lines: lines.length,
                        issues_found: 0,
                        issues: [],
                        analysis_time: new Date().toISOString()
                    };
                }

                // ÈÄêË°åÂàÜÊûê
                for (let i = 0; i < lines.length; i++) {
                    // Ê£ÄÊü•ÊòØÂê¶Ë¢´‰∏≠Êñ≠
                    if (analysisController?.signal.aborted) {
                        throw new DOMException('ÂàÜÊûêË¢´‰∏≠Êñ≠', 'AbortError');
                    }

                    const line = lines[i];
                    if (!line.trim()) continue;

                    // Â∫îÁî®ËßÑÂàôÊ£ÄÊµã
                    for (const rule of rules) {
                        if (rule.is_active !== false && applyRule(line, rule)) {
                            issues.push({
                                line_number: i + 1,
                                content: line,
                                rule_name: rule.name,
                                problem_type: rule.problem_type,
                                problem_description: rule.problem_description || rule.description,
                                severity: rule.priority > 5 ? 'high' : 'medium'
                            });
                            break; // Âè™Â∫îÁî®Á¨¨‰∏Ä‰∏™ÂåπÈÖçÁöÑËßÑÂàô
                        }
                    }

                    // ÊØèÂ§ÑÁêÜ1000Ë°åÊòæÁ§∫‰∏ÄÊ¨°ËøõÂ∫¶ÔºåÈÅøÂÖçÈ¢ëÁπÅÊõ¥Êñ∞
                    if (i % 1000 === 0 && i > 0) {
                        const progress = Math.round((i / lines.length) * 100);
                        showMessage(`Ê≠£Âú®ÂàÜÊûê... ${progress}%`, 'info');
                        // ËÆ©Âá∫ÊéßÂà∂ÊùÉÔºåÈÅøÂÖçÈòªÂ°ûUIÔºàÁº©Áü≠Êó∂Âª∂ÊèêÂçáÊµÅÁïÖÂ∫¶Ôºâ
                        await pause(0);
                    }
                }

                console.log('ÂàÜÊûêÂÆåÊàêÔºåÂèëÁé∞ÈóÆÈ¢ò:', issues.length);
                return {
                    filename: filename,
                    total_lines: lines.length,
                    issues_found: issues.length,
                    issues: issues,
                    analysis_time: new Date().toISOString()
                };
            } catch (error) {
                console.error('analyzeLogContent ÈîôËØØ:', error);
                throw error;
            }
        }

        // ËßÑÂàôÂ∫îÁî®ÈÄªËæë
        function applyRule(content, rule) {
            try {
                const pattern = rule.pattern;
                const ruleType = rule.rule_type || 'regex';

                switch (ruleType) {
                    case 'regex':
                        return new RegExp(pattern, 'i').test(content);
                    case 'keyword':
                        return content.toLowerCase().includes(pattern.toLowerCase());
                    default:
                        return false;
                }
            } catch (e) {
                console.error('ËßÑÂàôÂ∫îÁî®Â§±Ë¥•:', e);
                return false;
            }
        }

        // Ëé∑ÂèñÂΩìÂâçËßÑÂàô
        async function getCurrentRules() {
            // Ê†πÊçÆÁî®Êà∑ÈÄâÊã©ÂÜ≥ÂÆö‰ΩøÁî®Âì™ÁßçËßÑÂàô
            if (settings.useLocalRules) {
                // ‰ΩøÁî®Êú¨Âú∞ËßÑÂàôÔºå‰∏çËøûÊé•ÊúçÂä°Á´Ø
                console.log('‰ΩøÁî®Êú¨Âú∞ËßÑÂàô');
                return getLocalRules();
            } else {
                // ‰ΩøÁî®ÊúçÂä°Á´ØËßÑÂàô
                try {
                    console.log('Â∞ùËØïËé∑ÂèñÊúçÂä°Á´ØËßÑÂàô');
                    const rules = await fetchRulesFromServer();
                    if (rules && rules.length > 0) {
                        currentRules = rules;
                        return rules;
                    }
                } catch (e) {
                    console.log('ÊúçÂä°Á´ØËßÑÂàôËé∑ÂèñÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞Êú¨Âú∞ËßÑÂàô');
                    showMessage('ÊúçÂä°Á´ØËøûÊé•Â§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞ËßÑÂàô', 'warning');
                }

                // ÂõûÈÄÄÂà∞Êú¨Âú∞ËßÑÂàô
                return getLocalRules();
            }
        }

        // ‰ªéÊúçÂä°Á´ØËé∑ÂèñËßÑÂàô
        async function fetchRulesFromServer() {
            try {
                // ÂÖà‰ΩøÁî®ËßÑËåÉÂåñÂêéÁöÑ serverUrl
                sanitizeSettings();
                let url = `${settings.serverUrl}/api/v1/rules`;
                console.log('Â∞ùËØïËé∑ÂèñÊúçÂä°Á´ØËßÑÂàô:', url);

                try {
                    const response = await fetch(url);
                    console.log('ÊúçÂä°Á´ØÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('ÊúçÂä°Á´ØËøîÂõûÊï∞ÊçÆ:', data);

                        // Â§ÑÁêÜ‰∏çÂêåÁöÑËøîÂõûÊ†ºÂºè
                        let rules;
                        if (Array.isArray(data)) {
                            rules = data;
                        } else if (data.rules && Array.isArray(data.rules)) {
                            rules = data.rules;
                        } else {
                            console.error('ÊúçÂä°Á´ØËøîÂõûÊï∞ÊçÆÊ†ºÂºèÈîôËØØ:', data);
                            return null;
                        }

                        // ÁßªÈô§ÊúçÂä°Á´ØËßÑÂàô‰∏≠ÁöÑ priority Â≠óÊÆµÔºåÂõ†‰∏∫ÂÆ¢Êà∑Á´Ø‰∏ç‰ΩøÁî®
                        rules = rules.map(rule => {
                            const { priority, ...ruleWithoutPriority } = rule;
                            return ruleWithoutPriority;
                        });

                        console.log('Ëé∑ÂèñÂà∞ÊúçÂä°Á´ØËßÑÂàô:', rules.length, 'Êù°');
                        return rules;
                    } else {
                        console.error('ÊúçÂä°Á´ØÂìçÂ∫îÈîôËØØ:', response.status, response.statusText);
                    }
                } catch (e1) {
                    console.warn('È¶ñÊ¨°ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂ∞ùËØïÁ´ØÂè£ÂõûÈÄÄ:', e1);
                    // Â¶ÇÊûú‰ªçÁÑ∂Êúâ 8080 ÁöÑÂéÜÂè≤Âú∞ÂùÄÔºåÂõûÈÄÄÂà∞ 8001 ÂÜçËØï‰∏ÄÊ¨°
                    const fallbackUrl = url.replace('localhost:8080', 'localhost:8001').replace('127.0.0.1:8080', '127.0.0.1:8001');
                    if (fallbackUrl !== url) {
                        console.log('Â∞ùËØïÂõûÈÄÄURL:', fallbackUrl);
                        const resp2 = await fetch(fallbackUrl);
                        if (resp2.ok) {
                            const rules = await resp2.json();
                            console.log('ÂõûÈÄÄURLÊàêÂäüÔºåËé∑ÂèñÂà∞ËßÑÂàô:', rules.length, 'Êù°');
                            return rules;
                        }
                    }
                    throw e1;
                }
            } catch (e) {
                console.error('ÊúçÂä°Á´ØËßÑÂàôËé∑ÂèñÂ§±Ë¥•:', e);
            }
            return null;
        }

        // Ëé∑ÂèñÊú¨Âú∞ËßÑÂàô
        function getLocalRules() {
            try {
                const saved = localStorage.getItem('logAnalyzerRules');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('Êú¨Âú∞ËßÑÂàôÂä†ËΩΩÂ§±Ë¥•:', e);
            }

            // ËøîÂõûÈªòËÆ§ËßÑÂàôÔºà‰∏éÊúçÂä°Á´ØÂ≠óÊÆµ‰øùÊåÅ‰∏ÄËá¥Ôºâ
            return [
                {
                    id: 1,
                    name: 'ÈîôËØØÊó•ÂøóËßÑÂàô',
                    description: 'ÂåπÈÖç ERROR Á∫ßÂà´Êó•Âøó',
                    pattern: 'ERROR|error|Error',
                    rule_type: 'regex',
                    problem_type: 'error',
                    problem_description: 'ÂåπÈÖç ERROR Á∫ßÂà´Êó•Âøó',
                    priority: 8,
                    is_active: true,
                    created_by: 1,
                    created_at: new Date().toISOString(),
                    updated_at: null
                },
                {
                    id: 2,
                    name: 'Ë≠¶ÂëäÊó•ÂøóËßÑÂàô',
                    description: 'ÂåπÈÖç WARN Á∫ßÂà´Êó•Âøó',
                    pattern: 'WARN|warn|Warning|WARNING',
                    rule_type: 'regex',
                    problem_type: 'warning',
                    problem_description: 'ÂåπÈÖç WARN Á∫ßÂà´Êó•Âøó',
                    priority: 5,
                    is_active: true,
                    created_by: 1,
                    created_at: new Date().toISOString(),
                    updated_at: null
                },
                {
                    id: 3,
                    name: 'ÂºÇÂ∏∏Â†ÜÊ†àËßÑÂàô',
                    description: 'ÂåπÈÖçÂºÇÂ∏∏Â†ÜÊ†à‰ø°ÊÅØ',
                    pattern: 'Exception|exception|Traceback|traceback',
                    rule_type: 'regex',
                    problem_type: 'exception',
                    problem_description: 'ÂåπÈÖçÂºÇÂ∏∏Â†ÜÊ†à‰ø°ÊÅØ',
                    priority: 9,
                    is_active: true,
                    created_by: 1,
                    created_at: new Date().toISOString(),
                    updated_at: null
                }
            ];
        }

        // ‰øùÂ≠òÊú¨Âú∞ËßÑÂàô
        function saveLocalRules(rules) {
            try {
                localStorage.setItem('logAnalyzerRules', JSON.stringify(rules));
                currentRules = rules;
                updateRulesUI();
            } catch (e) {
                console.error('Êú¨Âú∞ËßÑÂàô‰øùÂ≠òÂ§±Ë¥•:', e);
            }
        }

        // ËßÑÂàôÁÆ°ÁêÜÂäüËÉΩ
        async function syncRules() {
            try {
                showMessage('Ê≠£Âú®ÂêåÊ≠•ËßÑÂàô...', 'info');
                console.log('ÂºÄÂßãÂêåÊ≠•ËßÑÂàôÔºåÂΩìÂâçÊúçÂä°Á´ØÂú∞ÂùÄ:', settings.serverUrl);

                if (!settings.serverUrl) {
                    showMessage('ËØ∑ÂÖàÈÖçÁΩÆÊúçÂä°Á´ØÂú∞ÂùÄ', 'warning');
                    return;
                }

                const serverRules = await fetchRulesFromServer();
                console.log('ÊúçÂä°Á´ØËßÑÂàôËé∑ÂèñÁªìÊûú:', serverRules);

                if (serverRules && Array.isArray(serverRules) && serverRules.length > 0) {
                    console.log('‰øùÂ≠òÊúçÂä°Á´ØËßÑÂàôÂà∞Êú¨Âú∞:', serverRules);
                    saveLocalRules(serverRules);

                    // È™åËØÅ‰øùÂ≠òÊòØÂê¶ÊàêÂäü
                    const savedRules = getLocalRules();
                    console.log('‰øùÂ≠òÂêéÊú¨Âú∞ËßÑÂàôÊï∞Èáè:', savedRules.length);

                    showMessage(`ÊàêÂäüÂêåÊ≠• ${serverRules.length} Êù°ËßÑÂàô`, 'success');
                } else {
                    console.warn('ÊúçÂä°Á´ØËßÑÂàô‰∏∫Á©∫ÊàñÊ†ºÂºèÈîôËØØ:', serverRules);
                    showMessage('ÊúçÂä°Á´ØËøûÊé•Â§±Ë¥•ÊàñÊó†ÂèØÁî®ËßÑÂàô', 'error');
                }

            } catch (error) {
                console.error('ËßÑÂàôÂêåÊ≠•Â§±Ë¥•:', error);
                showMessage('ËßÑÂàôÂêåÊ≠•Â§±Ë¥•: ' + error.message, 'error');
            }
        }



        function exportRules() {
            try {
                const rules = getLocalRules();
                const dataStr = JSON.stringify(rules, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'log_analyzer_rules.json';
                link.click();

                showMessage('ËßÑÂàôÂØºÂá∫ÊàêÂäü', 'success');
            } catch (error) {
                console.error('ËßÑÂàôÂØºÂá∫Â§±Ë¥•:', error);
                showMessage('ËßÑÂàôÂØºÂá∫Â§±Ë¥•', 'error');
            }
        }

        // Êõ¥Êñ∞ËßÑÂàôÁïåÈù¢
        function updateRulesUI() {
            const rulesList = document.getElementById('rules-list');
            if (!rulesList) return;

            const rules = getLocalRules();
            rulesList.innerHTML = '';

            rules.forEach(rule => {
                const ruleEl = document.createElement('div');
                ruleEl.style.cssText = 'padding: 16px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center;';

                const statusClass = rule.is_active ? 'status-success' : 'status-error';

                ruleEl.innerHTML = `
                    <div>
                        <span class="status-indicator ${statusClass}"></span>
                        <strong>${rule.name}</strong> - ${rule.problem_description || rule.description || ''}
                        <br><small style="color: #666;">Ê®°Âºè: ${rule.pattern}</small>
                        ${rule.priority !== undefined ? `<br><small style="color: #666;">‰ºòÂÖàÁ∫ß: ${rule.priority}</small>` : ''}
                    </div>
                    <div>
                        <button onclick="editRule(${rule.id})" style="margin-right: 8px; padding: 4px 8px; border: 1px solid #1890ff; background: white; color: #1890ff; border-radius: 4px; cursor: pointer;">
                            ÁºñËæë
                        </button>
                        <button onclick="toggleRule(${rule.id})" style="margin-right: 8px; padding: 4px 8px; border: 1px solid #d9d9d9; background: white; border-radius: 4px; cursor: pointer;">
                            ${rule.is_active ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}
                        </button>
                        <button onclick="deleteRule(${rule.id})" style="padding: 4px 8px; border: 1px solid #ff4d4f; background: #ff4d4f; color: white; border-radius: 4px; cursor: pointer;">
                            Âà†Èô§
                        </button>
                    </div>
                `;

                rulesList.appendChild(ruleEl);
            });
        }

        // ËßÑÂàôÊìç‰Ωú
        function toggleRule(ruleId) {
            const rules = getLocalRules();
            const rule = rules.find(r => r.id === ruleId);
            if (rule) {
                rule.is_active = !rule.is_active;
                saveLocalRules(rules);
                showMessage(`ËßÑÂàô "${rule.name}" Â∑≤${rule.is_active ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}`, 'success');
            }
        }

        function deleteRule(ruleId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËßÑÂàôÂêóÔºü')) return;

            const rules = getLocalRules();
            const filteredRules = rules.filter(r => r.id !== ruleId);
            saveLocalRules(filteredRules);
            showMessage('ËßÑÂàôÂà†Èô§ÊàêÂäü', 'success');
        }

        // ËßÑÂàôÁºñËæëÂäüËÉΩ
        let currentEditingRule = null;

        function addRule() {
            currentEditingRule = null;
            document.getElementById('rule-modal-title').textContent = 'Ê∑ªÂä†ËßÑÂàô';
            clearRuleForm();
            showRuleModal();
        }

        function editRule(ruleId) {
            const rules = getLocalRules();
            const rule = rules.find(r => r.id === ruleId);
            if (!rule) return;

            currentEditingRule = rule;
            document.getElementById('rule-modal-title').textContent = 'ÁºñËæëËßÑÂàô';
            fillRuleForm(rule);
            showRuleModal();
        }

        function showRuleModal() {
            console.log('ÊòæÁ§∫ËßÑÂàôÊ®°ÊÄÅÊ°Ü');
            console.trace('showRuleModal Ë∞ÉÁî®Â†ÜÊ†à');
            const modal = document.getElementById('rule-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                console.log('Ê®°ÊÄÅÊ°ÜÂ∑≤ÊòæÁ§∫');
            }
        }

        function closeRuleModal() {
            console.log('ÂÖ≥Èó≠ËßÑÂàôÊ®°ÊÄÅÊ°Ü');
            const modal = document.getElementById('rule-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                console.log('Ê®°ÊÄÅÊ°ÜÂ∑≤ÈöêËóè');
            } else {
                console.error('Êâæ‰∏çÂà∞ËßÑÂàôÊ®°ÊÄÅÊ°ÜÂÖÉÁ¥†');
            }
            currentEditingRule = null;
            clearRuleForm();
        }

        function clearRuleForm() {
            document.getElementById('rule-name').value = '';
            document.getElementById('rule-description').value = '';
            document.getElementById('rule-pattern').value = '';
            document.getElementById('rule-type').value = 'regex';
            document.getElementById('rule-problem-type').value = '';
            document.getElementById('rule-problem-description').value = '';
            document.getElementById('rule-active').checked = true;
        }

        function fillRuleForm(rule) {
            document.getElementById('rule-name').value = rule.name || '';
            document.getElementById('rule-description').value = rule.description || '';
            document.getElementById('rule-pattern').value = rule.pattern || '';
            document.getElementById('rule-type').value = rule.rule_type || 'regex';
            document.getElementById('rule-problem-type').value = rule.problem_type || '';
            document.getElementById('rule-problem-description').value = rule.problem_description || '';
            document.getElementById('rule-active').checked = rule.is_active !== false;
        }

        function saveRule() {
            try {
                const name = document.getElementById('rule-name').value.trim();
                const description = document.getElementById('rule-description').value.trim();
                const pattern = document.getElementById('rule-pattern').value.trim();
                const ruleType = document.getElementById('rule-type').value;
                const problemType = document.getElementById('rule-problem-type').value.trim();
                const problemDescription = document.getElementById('rule-problem-description').value.trim();
                const isActive = document.getElementById('rule-active').checked;

                if (!name || !pattern) {
                    showMessage('ËØ∑Â°´ÂÜôËßÑÂàôÂêçÁß∞ÂíåÂåπÈÖçÊ®°Âºè', 'warning');
                    return;
                }

                // È™åËØÅÊ≠£ÂàôË°®ËææÂºè
                if (ruleType === 'regex') {
                    try {
                        new RegExp(pattern);
                    } catch (e) {
                        showMessage('Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ: ' + e.message, 'error');
                        return;
                    }
                }

                const rules = getLocalRules();

                if (currentEditingRule) {
                    // ÁºñËæëÁé∞ÊúâËßÑÂàô
                    const index = rules.findIndex(r => r.id === currentEditingRule.id);
                    if (index !== -1) {
                        rules[index] = {
                            ...rules[index],
                            name,
                            description,
                            pattern,
                            rule_type: ruleType,
                            problem_type: problemType,
                            problem_description: problemDescription,
                            is_active: isActive,
                            updated_at: new Date().toISOString()
                        };
                    }
                } else {
                    // Ê∑ªÂä†Êñ∞ËßÑÂàô
                    const newId = Math.max(...rules.map(r => r.id), 0) + 1;
                    const newRule = {
                        id: newId,
                        name,
                        description,
                        pattern,
                        rule_type: ruleType,
                        problem_type: problemType,
                        problem_description: problemDescription,
                        is_active: isActive,
                        created_by: 1,
                        created_at: new Date().toISOString(),
                        updated_at: null
                    };
                    rules.push(newRule);
                }

                saveLocalRules(rules);
                closeRuleModal();
                showMessage(currentEditingRule ? 'ËßÑÂàôÊõ¥Êñ∞ÊàêÂäü' : 'ËßÑÂàôÊ∑ªÂä†ÊàêÂäü', 'success');
            } catch (error) {
                console.error('‰øùÂ≠òËßÑÂàôÊó∂Âá∫Èîô:', error);
                showMessage('‰øùÂ≠òËßÑÂàôÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
        function showAnalysisResult(result) {
            const reportPage = document.getElementById('report-page');
            if (!reportPage) return;

            reportPage.innerHTML = `
                <h1 class="page-title">ÂàÜÊûêÊä•Âëä</h1>
                <p class="page-subtitle">Êñá‰ª∂: ${result.filename}</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: #f0f2ff; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: #667eea;">${result.total_lines}</div>
                        <div style="color: #666;">ÊÄªË°åÊï∞</div>
                    </div>
                    <div style="background: #fff2e8; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: #fa8c16;">${result.issues_found}</div>
                        <div style="color: #666;">ÂèëÁé∞ÈóÆÈ¢ò</div>
                    </div>
                    <div style="background: #f6ffed; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: #52c41a;">${(result.issues || []).filter(i => i.severity === 'high').length}</div>
                        <div style="color: #666;">È´òÂç±ÈóÆÈ¢ò</div>
                    </div>
                    ${result.files_analyzed ? `
                    <div style="background: #e6f7ff; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: #1890ff;">${result.files_analyzed}</div>
                        <div style="color: #666;">ÂàÜÊûêÊñá‰ª∂</div>
                    </div>
                    ` : ''}
                </div>

                <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 16px;">ÈóÆÈ¢òËØ¶ÊÉÖ</h3>
                    <div id="issues-list">
                        <p style="color: #666; text-align: center; padding: 16px; margin: 0;">${(result.issues || []).length} Êù°ÈóÆÈ¢òÔºåÂ∞ÜÂàÜÊâπÊ∏≤Êüì‰ª•ÈÅøÂÖçÂç°È°ø...</p>
                    </div>
                    <div style="text-align:center; margin-top: 12px;">
                        <button id="load-more-btn" class="btn btn-secondary" type="button">Âä†ËΩΩÊõ¥Â§ö</button>
                    </div>
                </div>

                <div style="margin-top: 24px; text-align: center;">
                    <button class="btn" onclick="exportReport()">ÂØºÂá∫Êä•Âëä</button>
                    <button class="btn btn-secondary" onclick="switchTab('home')">ËøîÂõûÈ¶ñÈ°µ</button>
                </div>
            `;

            // ÂàÜÊâπÊ∏≤Êüì issuesÔºåÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÁîüÊàêÂ∑®Â§ß innerHTML
            renderIssuesIncrementally(result.issues || [], 200);


            // ‰øùÂ≠òÊúÄÊñ∞Êä•ÂëäÔºàËøõË°å‰ΩìÁßØË£ÅÂâ™ÔºåÈÅøÂÖç localStorage ËøáÂ§ßÂØºËá¥ RangeErrorÔºâ
            try {
                const slim = {
                    filename: result.filename,
                    total_lines: result.total_lines,
                    issues_found: result.issues_found,
                    analysis_time: result.analysis_time,
                    files_analyzed: result.files_analyzed,
                    // Âè™‰øùÂ≠òÈóÆÈ¢òÁöÑÂÖ≥ÈîÆÂ≠óÊÆµÔºåÈôêÂà∂ÊúÄÂ§ö 500 Êù°
                    issues: (result.issues || []).slice(0, 500).map(it => ({
                        type: it.type,
                        severity: it.severity,
                        file: it.file || it.source_file,
                        line: it.line,
                        message: (it.message || '').slice(0, 500)
                    }))
                };
                localStorage.setItem('lastAnalysisResult', JSON.stringify(slim));
            } catch (e) {
                console.warn('‰øùÂ≠òÂàÜÊûêÊä•ÂëäÂà∞Êú¨Âú∞Â§±Ë¥•:', e);
            }
        }

        // ÂØºÂá∫Êä•Âëä
        function exportReport() {
            try {
                const result = JSON.parse(localStorage.getItem('lastAnalysisResult') || '{}');
                if (!result.filename) {
                    showMessage('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÊä•Âëä', 'warning');
                    return;
                }

                const reportText = generateReportText(result);
                const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `analysis_report_${result.filename}_${new Date().toISOString().slice(0, 10)}.txt`;
                link.click();




                showMessage('Êä•ÂëäÂØºÂá∫ÊàêÂäü', 'success');
            } catch (error) {
                console.error('Êä•ÂëäÂØºÂá∫Â§±Ë¥•:', error);
                showMessage('Êä•ÂëäÂØºÂá∫Â§±Ë¥•', 'error');
            }
        }

        // ÁîüÊàêÊä•ÂëäÊñáÊú¨
        function generateReportText(result) {
            let text = `Êó•ÂøóÂàÜÊûêÊä•Âëä\n`;
            text += `================\n\n`;
            text += `Êñá‰ª∂Âêç: ${result.filename || '-'}\n`;
            text += `ÂàÜÊûêÊó∂Èó¥: ${(result.analysis_time ? new Date(result.analysis_time).toLocaleString() : new Date().toLocaleString())}\n`;
            text += `ÊÄªË°åÊï∞: ${result.total_lines || 0}\n`;
            text += `ÂèëÁé∞ÈóÆÈ¢ò: ${result.issues_found || (result.issues ? result.issues.length : 0)}\n\n`;

            const issues = result.issues || [];
            if (issues.length > 0) {
                text += `ÈóÆÈ¢òËØ¶ÊÉÖ:\n`;
                text += `--------\n\n`;

                issues.forEach((issue, index) => {
                    const ln = issue.line_number || issue.line || '-';
                    text += `${index + 1}. ${issue.rule_name || issue.type || 'ËßÑÂàôÂëΩ‰∏≠'} (Á¨¨ ${ln} Ë°å)\n`;
                    text += `   ‰∏•ÈáçÁ®ãÂ∫¶: ${issue.severity || '-'}\n`;
                    if (issue.problem_type) text += `   ÈóÆÈ¢òÁ±ªÂûã: ${issue.problem_type}\n`;
                    if (issue.problem_description) text += `   ÈóÆÈ¢òÊèèËø∞: ${issue.problem_description}\n`;
                    if (issue.file || issue.source_file) text += `   Êñá‰ª∂: ${issue.file || issue.source_file}\n`;
                    if (issue.content || issue.message) text += `   Êó•ÂøóÂÜÖÂÆπ: ${(issue.content || issue.message)}\n`;
                    text += `\n`;
                });
            } else {
                text += `Êú™ÂèëÁé∞ÈóÆÈ¢ò„ÄÇ\n`;
            }

            return text;
        }

        // ËÆæÁΩÆÂäüËÉΩ
        function saveAppSettings() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            const autoSync = document.getElementById('autoSync').checked;

            if (serverUrl && !serverUrl.startsWith('http')) {
                showMessage('ÊúçÂä°Á´ØÂú∞ÂùÄÂøÖÈ°ª‰ª• http:// Êàñ https:// ÂºÄÂ§¥', 'warning');
                return;
            }

            settings.serverUrl = serverUrl || 'http://172.17.20.117:8001';
            settings.autoSync = autoSync;

            saveSettings();
        }

        async function testConnection() {
            const serverUrl = document.getElementById('serverUrl').value.trim() || settings.serverUrl;

            if (!serverUrl) {
                showMessage('ËØ∑ÂÖàËæìÂÖ•ÊúçÂä°Á´ØÂú∞ÂùÄ', 'warning');
                return;
            }

            try {
                showMessage('Ê≠£Âú®ÊµãËØïËøûÊé•...', 'info');

                const response = await fetch(`${serverUrl}/api/v1/rules`, {
                    method: 'GET',
                    timeout: 5000
                });

                if (response.ok) {
                    showMessage('ËøûÊé•ÊàêÂäüÔºÅ', 'success');
                } else {
                    showMessage(`ËøûÊé•Â§±Ë¥•: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('ËøûÊé•ÊµãËØïÂ§±Ë¥•:', error);
                showMessage('ËøûÊé•Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        function clearAllData() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâËßÑÂàôÂíåËÆæÁΩÆ„ÄÇ')) {
                return;
            }

            try {
                localStorage.removeItem('logAnalyzerSettings');
                localStorage.removeItem('logAnalyzerRules');
                localStorage.removeItem('lastAnalysisResult');

                // ÈáçÁΩÆÁä∂ÊÄÅ
                settings = {
                    serverUrl: 'http://localhost:8001',
                    autoSync: true,
                    useLocalRules: true
                };
                currentRules = [];
                selectedFile = null;
                selectedBulkFile = null;

                // Êõ¥Êñ∞ÁïåÈù¢
                updateSettingsUI();
                updateRulesUI();

                showMessage('ÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÈô§', 'success');
            } catch (error) {
                console.error('Ê∏ÖÈô§Êï∞ÊçÆÂ§±Ë¥•:', error);
                showMessage('Ê∏ÖÈô§Êï∞ÊçÆÂ§±Ë¥•', 'error');
            }
        }

        // ÂàùÂßãÂåñÂ∫îÁî®
        function initApp() {
            // Âä†ËΩΩËÆæÁΩÆ
            loadSettings();

            // Á°Æ‰øùÊ®°ÊÄÅÊ°ÜÊòØÈöêËóèÁöÑ
            const modal = document.getElementById('rule-modal');
            if (modal) {
                console.log('ÂàùÂßãÂåñÂâçÊ®°ÊÄÅÊ°ÜÁ±ªÂêç:', modal.className);
                modal.classList.add('hidden');
                console.log('ÂàùÂßãÂåñÂêéÊ®°ÊÄÅÊ°ÜÁ±ªÂêç:', modal.className);
                console.log('Ê®°ÊÄÅÊ°ÜÊòØÂê¶ÈöêËóè:', modal.classList.contains('hidden'));
            } else {
                console.error('Êâæ‰∏çÂà∞ËßÑÂàôÊ®°ÊÄÅÊ°ÜÂÖÉÁ¥†');
            }

            // Êõ¥Êñ∞ËßÑÂàôÁïåÈù¢
            updateRulesUI();

            // ÂàùÂßãÂåñËßÑÂàôÈÄâÊã©Áä∂ÊÄÅ
            initializeRuleSourceUI();

            // Â¶ÇÊûúÂêØÁî®Ëá™Âä®ÂêåÊ≠•ÔºåÂ∞ùËØïÂêåÊ≠•ËßÑÂàô
            // ‰ªÖÂΩìÈÄâÊã©ÊúçÂä°Á´ØËßÑÂàôÊó∂ÊâçËá™Âä®ÂêåÊ≠•ÔºåÈÅøÂÖçÊú¨Âú∞ËßÑÂàôÊ®°ÂºèËß¶ÂèëÁΩëÁªúËØ∑Ê±Ç
            if (settings.autoSync && !settings.useLocalRules) {
                setTimeout(() => {
                    syncRules();
                }, 1000);
            }

            // Ê∑ªÂä†CSSÂä®Áîª
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }

        // ÂàùÂßãÂåñËßÑÂàôÈÄâÊã©ÁïåÈù¢
        function initializeRuleSourceUI() {
            // ËÆæÁΩÆÂçï‰∏™ÂàÜÊûêÈ°µÈù¢ÁöÑËßÑÂàôÈÄâÊã©
            const singleRadios = document.querySelectorAll('input[name="ruleSource"]');
            singleRadios.forEach(radio => {
                if (radio.value === (settings.useLocalRules ? 'local' : 'server')) {
                    radio.checked = true;
                }
            });

            // ËÆæÁΩÆÂÖ®ÈáèÂàÜÊûêÈ°µÈù¢ÁöÑËßÑÂàôÈÄâÊã©
            const bulkRadios = document.querySelectorAll('input[name="bulkRuleSource"]');
            bulkRadios.forEach(radio => {
                if (radio.value === (settings.useLocalRules ? 'local' : 'server')) {
                    radio.checked = true;
                }
            });

            // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
            updateRuleSource(settings.useLocalRules ? 'local' : 'server');
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ

        // ÂàÜÊâπÊ∏≤ÊüìÂáΩÊï∞ÔºöÊØèÊâπ batchSize Êù°ÔºåÁÇπÂáª‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊàñËá™Âä®È¶ñÊâπ
        function renderIssuesIncrementally(allIssues, batchSize = 200) {
            try {
                const container = document.getElementById('issues-list');
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (!container) return;

                let index = 0;
                function renderBatch() {
                    const end = Math.min(index + batchSize, allIssues.length);
                    const frag = document.createDocumentFragment();
                    for (let i = index; i < end; i++) {
                        const issue = allIssues[i] || {};
                        const div = document.createElement('div');
                        div.style.borderBottom = '1px solid #f0f0f0';
                        div.style.padding = '16px 0';
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                                <strong style="color: ${issue.severity === 'high' ? '#ff4d4f' : '#fa8c16'};">${issue.rule_name || issue.type || 'ËßÑÂàôÂëΩ‰∏≠'}</strong>
                                <div style="text-align:right;">
                                    ${issue.source_file ? `<div style="background:#f0f0f0; color:#666; padding:2px 8px; border-radius:4px; font-size:11px; margin-bottom:4px;">${issue.source_file}</div>` : ''}
                                    <span style="background:${issue.severity === 'high' ? '#ff4d4f' : '#fa8c16'}; color:white; padding:2px 8px; border-radius:4px; font-size:12px;">Á¨¨ ${issue.line_number || issue.line || '-'} Ë°å</span>
                                </div>
                            </div>
                            <div style="color:#666; margin-bottom:8px;">${issue.problem_description || ''}</div>
                            <div style="background:#f8f8f8; padding:8px; border-radius:4px; font-family:monospace; font-size:12px; overflow-x:auto;">${issue.content || issue.message || ''}</div>
                        `;
                        frag.appendChild(div);
                    }
                    if (index === 0) container.innerHTML = '';
                    container.appendChild(frag);
                    index = end;
                    if (loadMoreBtn) loadMoreBtn.style.display = index < allIssues.length ? 'inline-block' : 'none';
                }

                // ÂàùÊ¨°Ê∏≤Êüì
                renderBatch();
                if (loadMoreBtn) loadMoreBtn.onclick = renderBatch;
            } catch (e) {
                console.error('renderIssuesIncrementally error:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Á´ãÂç≥ÈöêËóèÊ®°ÊÄÅÊ°Ü
            const modal = document.getElementById('rule-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('DOMContentLoaded: Âº∫Âà∂ÈöêËóèÊ®°ÊÄÅÊ°Ü');
            }

            // ÁÑ∂ÂêéÂàùÂßãÂåñÂ∫îÁî®
            initApp();
        });

        // Ê∑ªÂä†Ê®°ÊÄÅÊ°ÜÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÂäüËÉΩ
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('rule-modal');
            if (event.target === modal) {
                closeRuleModal();
            }
        });

        // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÊîØÊåÅ ESC ÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('rule-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    closeRuleModal();
                }
            }
        });
    </script>
</body>
</html>
