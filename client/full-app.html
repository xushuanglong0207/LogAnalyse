<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—åˆ†æå·¥å…·</title>
    <link rel="stylesheet" href="https://unpkg.com/antd@5.12.0/dist/reset.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
        }

        .logo-icon {
            font-size: 24px;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-content {
            flex: 1;
            padding: 24px;
        }

        .tabs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-header {
            display: flex;
            background: #fafafa;
            border-bottom: 1px solid #e8e8e8;
        }

        .tab-button {
            flex: 1;
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .tab-button:hover {
            background: #f0f0f0;
        }

        .tab-content {
            padding: 32px;
            min-height: 500px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #666;
            margin-bottom: 32px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .feature-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .feature-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .feature-desc {
            color: #666;
            line-height: 1.6;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            margin: 8px;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .upload-area {
            border: 2px dashed #d9d9d9;
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-icon {
            font-size: 64px;
            color: #d9d9d9;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 14px;
            color: #999;
        }

        .hidden {
            display: none !important;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        /* æ·±è‰²æ¨¡å¼æ ·å¼ */
        .dark-theme {
            background-color: #1a1a1a;
            color: #e8e8e8;
        }

        .dark-theme .header {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }

        .dark-theme .nav-tabs {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }

        .dark-theme .nav-tab {
            background: #2d2d2d;
            color: #e8e8e8;
            border-color: #404040;
        }

        .dark-theme .nav-tab.active {
            background: #1a1a1a;
            color: #1890ff;
        }

        .dark-theme .main-content {
            background: #1a1a1a;
        }

        .dark-theme .upload-area {
            background: #2d2d2d;
            border-color: #404040;
        }

        .dark-theme .upload-area.dragover {
            background: #404040;
            border-color: #1890ff;
        }

        .dark-theme .btn {
            background: #2d2d2d;
            color: #e8e8e8;
            border-color: #404040;
        }

        .dark-theme .btn:hover {
            background: #404040;
        }

        .dark-theme .btn-primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .dark-theme .modal-content {
            background: #2d2d2d;
            color: #e8e8e8;
        }

        .dark-theme .modal-header,
        .dark-theme .modal-footer {
            border-color: #404040;
        }

        .dark-theme .form-group input,
        .dark-theme .form-group select,
        .dark-theme .form-group textarea {
            background: #1a1a1a;
            color: #e8e8e8;
            border-color: #404040;
        }

        .dark-theme .message {
            background: #2d2d2d;
            border-color: #404040;
        }

        .dark-theme .message.success {
            background: #1f5f1f;
            border-color: #52c41a;
        }

        .dark-theme .message.error {
            background: #5f1f1f;
            border-color: #ff4d4f;
        }

        .dark-theme .message.warning {
            background: #5f4f1f;
            border-color: #faad14;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #52c41a;
        }

        .status-error {
            background: #ff4d4f;
        }

        .status-warning {
            background: #faad14;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">ğŸ“Š</span>
                <span>æ—¥å¿—åˆ†æå·¥å…·</span>
                <span style="font-size: 12px; opacity: 0.8;">v1.0.0</span>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                ğŸŒ™ æ·±è‰²æ¨¡å¼
            </button>
        </header>

        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <div class="tabs-container">
                <!-- Tab å¤´éƒ¨ -->
                <div class="tab-header">
                    <button class="tab-button active" onclick="switchTab('home')">
                        ğŸ  é¦–é¡µ
                    </button>
                    <button class="tab-button" onclick="switchTab('single')">
                        ğŸ“„ å•ä¸ªåˆ†æ
                    </button>
                    <button class="tab-button" onclick="switchTab('bulk')">
                        ğŸ“ å…¨é‡åˆ†æ
                    </button>
                    <button class="tab-button" onclick="switchTab('rules')">
                        ğŸ“‹ è§„åˆ™ç®¡ç†
                    </button>
                    <button class="tab-button" onclick="switchTab('report')">
                        ğŸ“Š åˆ†ææŠ¥å‘Š
                    </button>
                    <button class="tab-button" onclick="switchTab('settings')">
                        âš™ï¸ è®¾ç½®
                    </button>
                </div>

                <!-- Tab å†…å®¹ -->
                <div class="tab-content">
                    <!-- é¦–é¡µ -->
                    <div id="home-page" class="tab-page">
                        <h1 class="page-title">æ¬¢è¿ä½¿ç”¨æ—¥å¿—åˆ†æå·¥å…·</h1>
                        <p class="page-subtitle">æ¡Œé¢ç«¯æ—¥å¿—åˆ†æå·¥å…· - æ”¯æŒæœ¬åœ°å’ŒæœåŠ¡ç«¯è§„åˆ™åŒæ­¥ï¼Œå‹ç¼©åŒ…å…¨é‡åˆ†æ</p>

                        <div class="feature-grid">
                            <div class="feature-card" onclick="switchTab('single')">
                                <div class="feature-icon">ğŸ“„</div>
                                <div class="feature-title">å•ä¸ªæ—¥å¿—åˆ†æ</div>
                                <div class="feature-desc">é€‰æ‹©å•ä¸ªæ—¥å¿—æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œå¿«é€Ÿå®šä½é—®é¢˜</div>
                            </div>

                            <div class="feature-card" onclick="switchTab('bulk')">
                                <div class="feature-icon">ğŸ“</div>
                                <div class="feature-title">å…¨é‡å‹ç¼©åŒ…åˆ†æ</div>
                                <div class="feature-desc">ä¸Šä¼ æ—¥å¿—å‹ç¼©åŒ…ï¼Œè‡ªåŠ¨è§£å‹å¹¶åˆ†ææ‰€æœ‰æ—¥å¿—æ–‡ä»¶</div>
                            </div>

                            <div class="feature-card" onclick="switchTab('rules')">
                                <div class="feature-icon">ğŸ“‹</div>
                                <div class="feature-title">è§„åˆ™ç®¡ç†</div>
                                <div class="feature-desc">ç®¡ç†æœ¬åœ°è§„åˆ™ï¼Œä¸æœåŠ¡ç«¯åŒå‘åŒæ­¥</div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 32px;">
                            <button class="btn" onclick="switchTab('single')">å¼€å§‹åˆ†æ</button>
                            <button class="btn btn-secondary" onclick="switchTab('settings')">æŸ¥çœ‹è®¾ç½®</button>
                        </div>
                    </div>

                    <!-- å•ä¸ªåˆ†æé¡µé¢ -->
                    <div id="single-page" class="tab-page hidden">
                        <h1 class="page-title">å•ä¸ªæ—¥å¿—åˆ†æ</h1>
                        <p class="page-subtitle">é€‰æ‹©å•ä¸ªæ—¥å¿—æ–‡ä»¶è¿›è¡Œåˆ†æ</p>

                        <div class="upload-area" onclick="selectSingleFile()">
                            <div class="upload-icon">ğŸ“„</div>
                            <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ—¥å¿—æ–‡ä»¶</div>
                            <div class="upload-hint">æ”¯æŒ .log, .txt ç­‰æ ¼å¼</div>
                        </div>

                        <!-- è§„åˆ™é€‰æ‹© -->
                        <div style="margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">è§„åˆ™é€‰æ‹©</h3>
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="ruleSource" value="local" checked onchange="updateRuleSource('local')">
                                    <span>ä½¿ç”¨æœ¬åœ°è§„åˆ™</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="ruleSource" value="server" onchange="updateRuleSource('server')">
                                    <span>ä½¿ç”¨æœåŠ¡ç«¯è§„åˆ™</span>
                                </label>
                            </div>
                            <div id="rule-status" style="margin-top: 8px; font-size: 12px; color: #666;">
                                å½“å‰ä½¿ç”¨æœ¬åœ°è§„åˆ™ï¼Œæ— éœ€è¿æ¥æœåŠ¡ç«¯
                            </div>
                        </div>

                        <div style="margin-top: 24px; text-align: center;">
                            <button class="btn" onclick="selectSingleFile()">é€‰æ‹©æ–‡ä»¶</button>
                            <button class="btn btn-primary" onclick="startSingleAnalysis()" id="single-analyze-btn">å¼€å§‹åˆ†æ</button>
                            <button class="btn btn-secondary" onclick="stopAnalysis()" id="single-stop-btn" style="display: none;">åœæ­¢åˆ†æ</button>
                        </div>
                    </div>

                    <!-- å…¨é‡åˆ†æé¡µé¢ -->
                    <div id="bulk-page" class="tab-page hidden">
                        <h1 class="page-title">å…¨é‡å‹ç¼©åŒ…åˆ†æ</h1>
                        <p class="page-subtitle">ä¸Šä¼ æ—¥å¿—å‹ç¼©åŒ…ï¼Œè‡ªåŠ¨è§£å‹å¹¶åˆ†ææ‰€æœ‰æ—¥å¿—æ–‡ä»¶</p>

                        <div class="upload-area" onclick="selectBulkFile()">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">ç‚¹å‡»é€‰æ‹©å‹ç¼©åŒ…</div>
                            <div class="upload-hint">æ”¯æŒ .zip, .tar, .gz, .tgz ç­‰æ ¼å¼</div>
                        </div>

                        <!-- è§„åˆ™é€‰æ‹© -->
                        <div style="margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">è§„åˆ™é€‰æ‹©</h3>
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkRuleSource" value="local" checked onchange="updateRuleSource('local')">
                                    <span>ä½¿ç”¨æœ¬åœ°è§„åˆ™</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkRuleSource" value="server" onchange="updateRuleSource('server')">
                                    <span>ä½¿ç”¨æœåŠ¡ç«¯è§„åˆ™</span>
                                </label>
                            </div>
                            <div id="bulk-rule-status" style="margin-top: 8px; font-size: 12px; color: #666;">
                                å½“å‰ä½¿ç”¨æœ¬åœ°è§„åˆ™ï¼Œæ— éœ€è¿æ¥æœåŠ¡ç«¯
                            </div>
                        </div>

                        <div style="margin-top: 24px; text-align: center;">
                            <button class="btn" onclick="selectBulkFile()">é€‰æ‹©å‹ç¼©åŒ…</button>
                            <button class="btn btn-primary" onclick="startBulkAnalysis()" id="bulk-analyze-btn">å¼€å§‹åˆ†æ</button>
                            <button class="btn btn-secondary" onclick="stopAnalysis()" id="bulk-stop-btn" style="display: none;">åœæ­¢åˆ†æ</button>
                        </div>
                    </div>

                    <!-- è§„åˆ™ç®¡ç†é¡µé¢ -->
                    <div id="rules-page" class="tab-page hidden">
                        <h1 class="page-title">è§„åˆ™ç®¡ç†</h1>
                        <p class="page-subtitle">ç®¡ç†æœ¬åœ°è§„åˆ™ï¼Œä¸æœåŠ¡ç«¯åŒå‘åŒæ­¥</p>

                        <div style="margin-bottom: 24px;">
                            <button class="btn" onclick="syncRules()">åŒæ­¥è§„åˆ™</button>
                            <button class="btn btn-secondary" onclick="addRule()">æ·»åŠ è§„åˆ™</button>
                            <button class="btn btn-secondary" onclick="exportRules()">å¯¼å‡ºè§„åˆ™</button>
                        </div>

                        <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
                            <h3>è§„åˆ™åˆ—è¡¨</h3>
                            <div id="rules-list">
                                <!-- è§„åˆ™åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- è§„åˆ™ç¼–è¾‘æ¨¡æ€æ¡† -->
                        <div id="rule-modal" class="modal hidden">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 id="rule-modal-title">ç¼–è¾‘è§„åˆ™</h3>
                                    <button class="modal-close" onclick="closeRuleModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <form id="rule-form">
                                        <div class="form-group">
                                            <label for="rule-name">è§„åˆ™åç§°:</label>
                                            <input type="text" id="rule-name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-description">è§„åˆ™æè¿°:</label>
                                            <textarea id="rule-description" rows="2"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-pattern">åŒ¹é…æ¨¡å¼:</label>
                                            <input type="text" id="rule-pattern" required placeholder="ERROR|error|Error">
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-type">è§„åˆ™ç±»å‹:</label>
                                            <select id="rule-type">
                                                <option value="regex">æ­£åˆ™è¡¨è¾¾å¼</option>
                                                <option value="keyword">å…³é”®å­—</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-problem-type">é—®é¢˜ç±»å‹:</label>
                                            <input type="text" id="rule-problem-type" placeholder="error">
                                        </div>
                                        <div class="form-group">
                                            <label for="rule-problem-description">é—®é¢˜æè¿°:</label>
                                            <textarea id="rule-problem-description" rows="2"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                <input type="checkbox" id="rule-active" checked>
                                                å¯ç”¨è§„åˆ™
                                            </label>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" onclick="closeRuleModal()">å–æ¶ˆ</button>
                                    <button class="btn btn-primary" onclick="saveRule()">ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ†ææŠ¥å‘Šé¡µé¢ -->
                    <div id="report-page" class="tab-page hidden">
                        <h1 class="page-title">åˆ†ææŠ¥å‘Š</h1>
                        <p class="page-subtitle">æŸ¥çœ‹å†å²åˆ†ææŠ¥å‘Šå’Œç»“æœ</p>

                        <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
                            <h3>æœ€è¿‘çš„åˆ†ææŠ¥å‘Š</h3>
                            <p style="color: #666; margin-top: 16px;">æš‚æ— åˆ†ææŠ¥å‘Šï¼Œè¯·å…ˆè¿›è¡Œæ—¥å¿—åˆ†æ</p>
                        </div>
                    </div>

                    <!-- è®¾ç½®é¡µé¢ -->
                    <div id="settings-page" class="tab-page hidden">
                        <h1 class="page-title">è®¾ç½®</h1>
                        <p class="page-subtitle">é…ç½®åº”ç”¨è®¾ç½®å’Œåå¥½</p>

                        <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
                            <h3>åº”ç”¨è®¾ç½®</h3>
                            <div style="margin: 16px 0;">
                                <label style="display: block; margin-bottom: 8px;">æœåŠ¡ç«¯åœ°å€:</label>
                                <input type="text" id="serverUrl" placeholder="http://localhost:8001" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <small style="color: #666;">ç”¨äºè§„åˆ™åŒæ­¥å’Œè¿œç¨‹åˆ†æ</small>
                            </div>
                            <div style="margin: 16px 0;">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" id="autoSync" style="margin-right: 8px;">
                                    è‡ªåŠ¨åŒæ­¥è§„åˆ™
                                </label>
                                <small style="color: #666;">å¯åŠ¨æ—¶è‡ªåŠ¨ä»æœåŠ¡ç«¯åŒæ­¥è§„åˆ™</small>
                            </div>
                            <div style="margin: 16px 0;">
                                <button class="btn" onclick="saveAppSettings()">ä¿å­˜è®¾ç½®</button>
                                <button class="btn btn-secondary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; padding: 24px; border-radius: 8px; margin-top: 24px;">
                            <h3>å…³äº</h3>
                            <p>æ—¥å¿—åˆ†æå·¥å…· v1.0.0</p>
                            <p>æ”¯æŒæœ¬åœ°å’ŒæœåŠ¡ç«¯è§„åˆ™åŒæ­¥ï¼Œå‹ç¼©åŒ…å…¨é‡åˆ†æ</p>
                            <div style="margin-top: 16px;">
                                <button class="btn btn-secondary" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Tab åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰é¡µé¢
            const pages = document.querySelectorAll('.tab-page');
            pages.forEach(page => page.classList.add('hidden'));

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ active çŠ¶æ€
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            const targetPage = document.getElementById(tabName + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            // æ¿€æ´»å¯¹åº”æŒ‰é’®
            const targetButton = event?.target || document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-theme');

            if (isDark) {
                body.classList.remove('dark-theme');
                document.querySelector('.theme-toggle').textContent = 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
            } else {
                body.classList.add('dark-theme');
                document.querySelector('.theme-toggle').textContent = 'â˜€ï¸ æµ…è‰²æ¨¡å¼';
            }
        }

        // å…¨å±€çŠ¶æ€
        let selectedFile = null;
        let selectedBulkFile = null;
        let currentRules = [];
        let analysisController = null; // ç”¨äºåœæ­¢åˆ†æ
        let settings = {
            serverUrl: 'http://localhost:8001',
            autoSync: true,
            useLocalRules: true // é»˜è®¤ä½¿ç”¨æœ¬åœ°è§„åˆ™
        };

        // è§„èŒƒåŒ–ä¸ä¿®å¤å†å²è®¾ç½®ï¼ˆç«¯å£/URLç­‰ï¼‰
        function sanitizeSettings() {
            try {
                if (typeof settings.serverUrl === 'string') {
                    // å»æ‰å°¾éƒ¨æ–œæ 
                    settings.serverUrl = settings.serverUrl.replace(/\/$/, '');
                    // å°†å†å²é—ç•™çš„ 8080 ç«¯å£è¿ç§»åˆ° 8001
                    if (settings.serverUrl.includes('localhost:8080')) {
                        settings.serverUrl = settings.serverUrl.replace('localhost:8080', 'localhost:8001');
                    }
                    if (settings.serverUrl.includes('127.0.0.1:8080')) {
                        settings.serverUrl = settings.serverUrl.replace('127.0.0.1:8080', '127.0.0.1:8001');
                    }
                }
            } catch (e) {
                console.warn('sanitizeSettings å¤±è´¥:', e);
            }
        }

        // ä»ç•Œé¢è¯»å–å½“å‰è§„åˆ™æºï¼ˆå•é€‰æ¡†ä¸ºå‡†ï¼‰
        function getUISelectedRuleSource(forBulk = false) {
            const name = forBulk ? 'bulkRuleSource' : 'ruleSource';
            const checked = document.querySelector(`input[name="${name}"]:checked`);
            return checked ? checked.value : (settings.useLocalRules ? 'local' : 'server');
        }

        // å¼‚æ­¥è®©å‡ºï¼ˆé¿å…é•¿æ—¶é—´é˜»å¡UIï¼‰
        function pause(ms = 0) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }



        // åŠ è½½è®¾ç½®
        function loadSettings() {
            try {
                const saved = localStorage.getItem('logAnalyzerSettings');
                if (saved) {
                    settings = { ...settings, ...JSON.parse(saved) };
                }
                // ç»Ÿä¸€ä¿®å¤å†å²URLä¸ç«¯å£
                sanitizeSettings();
                updateSettingsUI();
            } catch (e) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e);
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            try {
                localStorage.setItem('logAnalyzerSettings', JSON.stringify(settings));
                showMessage('è®¾ç½®å·²ä¿å­˜', 'success');
            } catch (e) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
                showMessage('ä¿å­˜è®¾ç½®å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°è®¾ç½®ç•Œé¢
        function updateSettingsUI() {
            const serverUrlInput = document.getElementById('serverUrl');
            const autoSyncCheckbox = document.getElementById('autoSync');
            if (serverUrlInput) serverUrlInput.value = settings.serverUrl;
            if (autoSyncCheckbox) autoSyncCheckbox.checked = settings.autoSync;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆå»é‡ + å•ä¾‹ + èŠ‚æµï¼Œé˜²æ­¢åˆ·å±å¡é¡¿ï¼‰
        function showMessage(message, type = 'info') {
            try {
                const now = Date.now();
                const isProgress = /æ­£åœ¨åˆ†æ|å¼€å§‹è§£å‹|æ­£åœ¨æµ‹è¯•è¿æ¥|æ­£åœ¨åŒæ­¥è§„åˆ™/.test(message);
                const duration = type === 'info' ? (isProgress ? 800 : 1500) : 3000;

                // å…¨å±€å•ä¾‹å…ƒç´ 
                if (!window.__toastEl) {
                    const el = document.createElement('div');
                    el.id = 'global-toast';
                    el.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 12px 24px;
                        border-radius: 6px;
                        color: white;
                        font-weight: 500;
                        z-index: 10000;
                        max-width: 60vw;
                        pointer-events: none;
                        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                    `;
                    document.body.appendChild(el);
                    window.__toastEl = el;
                }

                const el = window.__toastEl;

                // èŠ‚æµï¼š500ms å†…é‡å¤ info æç¤ºç›´æ¥æ›´æ–°æ–‡æœ¬ä¸é‡æ’
                if (type === 'info' && window.__lastToastTime && (now - window.__lastToastTime) < 500) {
                    el.textContent = message;
                } else {
                    // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
                    switch (type) {
                        case 'success':
                            el.style.background = '#52c41a';
                            break;
                        case 'error':
                            el.style.background = '#ff4d4f';
                            break;
                        case 'warning':
                            el.style.background = '#faad14';
                            break;
                        default:
                            el.style.background = '#1890ff';
                    }
                    el.textContent = message;
                }

                el.style.display = 'block';
                window.__lastToastTime = now;

                // é‡ç½®è®¡æ—¶å™¨ï¼šåªä¿ç•™ä¸€ä¸ªå®šæ—¶å™¨
                if (window.__toastTimer) clearTimeout(window.__toastTimer);
                window.__toastTimer = setTimeout(() => {
                    el.style.display = 'none';
                }, duration);
            } catch (e) {
                console.warn('showMessage fallback:', e);
                alert(message);
            }
        }

        // æ–‡ä»¶é€‰æ‹©åŠŸèƒ½
        function selectSingleFile() {
            if (window.require) {
                const { ipcRenderer } = window.require('electron');
                ipcRenderer.invoke('select-file', {
                    filters: [
                        { name: 'æ—¥å¿—æ–‡ä»¶', extensions: ['log', 'txt', 'out', 'syslog', 'kern', 'auth', 'messages', 'dmesg', 'access', 'error'] },
                        { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }
                    ]
                }).then(result => {
                    if (!result.canceled && result.filePaths.length > 0) {
                        selectedFile = result.filePaths[0];
                        updateSingleFileUI();
                        showMessage('å·²é€‰æ‹©æ–‡ä»¶: ' + selectedFile.split('\\').pop(), 'success');
                    }
                });
            } else {
                showMessage('è¯·åœ¨ Electron ç¯å¢ƒä¸­ä½¿ç”¨æ­¤åŠŸèƒ½', 'error');
            }
        }

        function selectBulkFile() {
            if (window.require) {
                const { ipcRenderer } = window.require('electron');
                ipcRenderer.invoke('select-file', {
                    filters: [
                        { name: 'å‹ç¼©æ–‡ä»¶', extensions: ['zip', 'rar', '7z', 'tar', 'gz', 'tgz'] },
                        { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }
                    ]
                }).then(result => {
                    if (!result.canceled && result.filePaths.length > 0) {
                        selectedBulkFile = result.filePaths[0];
                        updateBulkFileUI();
                        showMessage('å·²é€‰æ‹©å‹ç¼©åŒ…: ' + selectedBulkFile.split('\\').pop(), 'success');
                    }
                });
            } else {
                showMessage('è¯·åœ¨ Electron ç¯å¢ƒä¸­ä½¿ç”¨æ­¤åŠŸèƒ½', 'error');
            }
        }

        // æ›´æ–°æ–‡ä»¶é€‰æ‹©ç•Œé¢
        function updateSingleFileUI() {
            const uploadArea = document.querySelector('#single-page .upload-area');
            if (uploadArea && selectedFile) {
                uploadArea.innerHTML = `
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">å·²é€‰æ‹©: ${selectedFile.split('\\').pop()}</div>
                    <div class="upload-hint">ç‚¹å‡»é‡æ–°é€‰æ‹©æ–‡ä»¶</div>
                `;
            }
        }

        function updateBulkFileUI() {
            const uploadArea = document.querySelector('#bulk-page .upload-area');
            if (uploadArea && selectedBulkFile) {
                uploadArea.innerHTML = `
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">å·²é€‰æ‹©: ${selectedBulkFile.split('\\').pop()}</div>
                    <div class="upload-hint">ç‚¹å‡»é‡æ–°é€‰æ‹©å‹ç¼©åŒ…</div>
                `;
            }
        }

        // è§„åˆ™æºé€‰æ‹©
        function updateRuleSource(source) {
            settings.useLocalRules = (source === 'local');

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusElements = ['rule-status', 'bulk-rule-status'];
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (source === 'local') {
                        element.textContent = 'å½“å‰ä½¿ç”¨æœ¬åœ°è§„åˆ™ï¼Œæ— éœ€è¿æ¥æœåŠ¡ç«¯';
                        element.style.color = '#52c41a';
                    } else {
                        element.textContent = 'å½“å‰ä½¿ç”¨æœåŠ¡ç«¯è§„åˆ™ï¼Œéœ€è¦ç½‘ç»œè¿æ¥';
                        element.style.color = '#fa8c16';
                    }
                }
            });

            // ä¿å­˜è®¾ç½®
            localStorage.setItem('logAnalyzerSettings', JSON.stringify(settings));
            showMessage(`å·²åˆ‡æ¢åˆ°${source === 'local' ? 'æœ¬åœ°' : 'æœåŠ¡ç«¯'}è§„åˆ™`, 'success');
        }

        // åœæ­¢åˆ†æ
        function stopAnalysis() {
            if (analysisController) {
                analysisController.abort();
                analysisController = null;
            }

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const analyzeButtons = ['single-analyze-btn', 'bulk-analyze-btn'];
            const stopButtons = ['single-stop-btn', 'bulk-stop-btn'];

            analyzeButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.style.display = 'inline-block';
                    btn.disabled = false;
                }
            });

            stopButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.style.display = 'none';
            });

            showMessage('åˆ†æå·²åœæ­¢', 'info');
        }

        // åˆ†æåŠŸèƒ½
        async function startSingleAnalysis() {
            if (!selectedFile) {
                showMessage('è¯·å…ˆé€‰æ‹©æ—¥å¿—æ–‡ä»¶', 'warning');
                return;
            }

            try {
                // åˆ›å»ºä¸­æ–­æ§åˆ¶å™¨
                analysisController = new AbortController();

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('single-analyze-btn').style.display = 'none';
                document.getElementById('single-stop-btn').style.display = 'inline-block';

                showMessage('å¼€å§‹åˆ†ææ—¥å¿—æ–‡ä»¶...', 'info');

                // æ£€æŸ¥ Electron ç¯å¢ƒ
                if (!window.require) {
                    throw new Error('è¯·åœ¨ Electron ç¯å¢ƒä¸­è¿è¡Œæ­¤åº”ç”¨');
                }

                // è¯»å–æ–‡ä»¶å†…å®¹
                const fs = window.require('fs');
                const path = window.require('path');

                console.log('è¯»å–æ–‡ä»¶:', selectedFile);
                const content = fs.readFileSync(selectedFile, 'utf8');
                const filename = path.basename(selectedFile);
                console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œæ–‡ä»¶å:', filename, 'å†…å®¹é•¿åº¦:', content.length);

                // æ ¹æ®â€œç•Œé¢å•é€‰æ¡†â€é€‰æ‹©åˆ†ææ–¹å¼ï¼Œé¿å…è®¾ç½®ä¸UIä¸ä¸€è‡´
                const uiSource = getUISelectedRuleSource(false);
                settings.useLocalRules = (uiSource === 'local');
                console.log('ä½¿ç”¨è§„åˆ™æº:', uiSource, 'useLocalRules:', settings.useLocalRules);

                let result;
                if (settings.useLocalRules) {
                    console.log('ä½¿ç”¨æœ¬åœ°è§„åˆ™åˆ†æ');
                    result = await analyzeLogContent(content, filename);
                } else {
                    console.log('ä½¿ç”¨æœåŠ¡ç«¯è§„åˆ™åˆ†æ');
                    result = await analyzeWithServerRules(content, filename);
                }

                // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
                if (analysisController.signal.aborted) {
                    console.log('åˆ†æè¢«ä¸­æ–­');
                    return;
                }

                console.log('åˆ†æç»“æœ:', result);

                // æ˜¾ç¤ºç»“æœ
                showAnalysisResult(result);
                switchTab('report');
                showMessage('åˆ†æå®Œæˆ', 'success');

            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('åˆ†æå·²è¢«ç”¨æˆ·åœæ­¢', 'info');
                    return;
                }
                console.error('åˆ†æå¤±è´¥:', error);
                showMessage('åˆ†æå¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('single-analyze-btn').style.display = 'inline-block';
                document.getElementById('single-stop-btn').style.display = 'none';
                analysisController = null;
            }
        }

        async function startBulkAnalysis() {
            if (!selectedBulkFile) {
                showMessage('è¯·å…ˆé€‰æ‹©å‹ç¼©åŒ…', 'warning');
                return;
            }

            try {
                // åˆ›å»ºä¸­æ–­æ§åˆ¶å™¨
                analysisController = new AbortController();

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('bulk-analyze-btn').style.display = 'none';
                document.getElementById('bulk-stop-btn').style.display = 'inline-block';

                showMessage('å¼€å§‹è§£å‹å¹¶åˆ†æå‹ç¼©åŒ…...', 'info');

                // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
                const fileName = selectedBulkFile.toLowerCase();
                const isSupported = fileName.endsWith('.zip') ||
                                  fileName.endsWith('.tar') ||
                                  fileName.endsWith('.gz') ||
                                  fileName.endsWith('.tgz');

                if (!isSupported) {
                    showMessage('æš‚ä¸æ”¯æŒæ­¤å‹ç¼©æ ¼å¼ï¼Œè¯·ä½¿ç”¨ .zip, .tar, .gz, .tgz æ ¼å¼', 'warning');
                    return;
                }

                // è§£å‹å¹¶åˆ†æï¼ˆå¼€å§‹å‰ä»¥ç•Œé¢å•é€‰æ¡†ä¸ºå‡†ï¼‰
                const uiSourceBulk = getUISelectedRuleSource(true);
                settings.useLocalRules = (uiSourceBulk === 'local');

                const result = await extractAndAnalyzeArchive(selectedBulkFile);

                // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
                if (analysisController.signal.aborted) {
                    return;
                }

                // æ˜¾ç¤ºç»“æœ
                showAnalysisResult(result);
                switchTab('report');

            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('åˆ†æå·²è¢«ç”¨æˆ·åœæ­¢', 'info');
                    return;
                }
                console.error('æ‰¹é‡åˆ†æå¤±è´¥:', error);
                showMessage('æ‰¹é‡åˆ†æå¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('bulk-analyze-btn').style.display = 'inline-block';
                document.getElementById('bulk-stop-btn').style.display = 'none';
                analysisController = null;
            }
        }

        // è§£å‹å¹¶åˆ†æå‹ç¼©åŒ…
        async function extractAndAnalyzeArchive(archivePath) {
            const path = window.require('path');
            const fs = window.require('fs');
            const os = window.require('os');
            const { spawn } = window.require('child_process');

            // åˆ›å»ºä¸´æ—¶ç›®å½•
            const tempDir = path.join(os.tmpdir(), 'log_analyzer_' + Date.now());
            fs.mkdirSync(tempDir, { recursive: true });

            try {
                // è§£å‹æ–‡ä»¶
                await extractArchive(archivePath, tempDir);

                // æŸ¥æ‰¾æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
                const logFiles = findLogFiles(tempDir);

                if (logFiles.length === 0) {
                    throw new Error('å‹ç¼©åŒ…ä¸­æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶');
                }

                showMessage(`æ‰¾åˆ° ${logFiles.length} ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå¼€å§‹åˆ†æ...`, 'info');

                // åˆ†ææ‰€æœ‰æ—¥å¿—æ–‡ä»¶
                const allIssues = [];
                let totalLines = 0;

                for (let i = 0; i < logFiles.length; i++) {
                    const logFile = logFiles[i];
                    try {
                        // æ˜¾ç¤ºæ–‡ä»¶çº§åˆ«çš„è¿›åº¦
                        const fileProgress = Math.round(((i + 1) / logFiles.length) * 100);
                        showMessage(`æ­£åœ¨åˆ†ææ–‡ä»¶ ${i + 1}/${logFiles.length} (${fileProgress}%)`, 'info');

                        const content = fs.readFileSync(logFile, 'utf8');
                        const fileName = path.relative(tempDir, logFile);

                        const result = await analyzeLogContent(content, fileName);
                        totalLines += result.total_lines;

                        // ä¸ºæ¯ä¸ªé—®é¢˜æ·»åŠ æ–‡ä»¶ä¿¡æ¯
                        result.issues.forEach(issue => {
                            issue.source_file = fileName;
                            allIssues.push(issue);
                        });

                        // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
                        if (analysisController?.signal.aborted) {
                            throw new DOMException('åˆ†æè¢«ä¸­æ–­', 'AbortError');
                        }

                        // æ¯å¤„ç†å®Œä¸€ä¸ªæ–‡ä»¶ï¼Œè®©å‡ºä¸€æ¬¡ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
                        await pause(0);

                    } catch (e) {
                        if (e.name === 'AbortError') {
                            throw e;
                        }
                        console.warn(`åˆ†ææ–‡ä»¶ ${logFile} å¤±è´¥:`, e);
                    }
                }

                return {
                    filename: path.basename(archivePath),
                    total_lines: totalLines,
                    issues_found: allIssues.length,
                    issues: allIssues,
                    analysis_time: new Date().toISOString(),
                    files_analyzed: logFiles.length
                };

            } finally {
                // æ¸…ç†ä¸´æ—¶ç›®å½•
                try {
                    fs.rmSync(tempDir, { recursive: true, force: true });
                } catch (e) {
                    console.warn('æ¸…ç†ä¸´æ—¶ç›®å½•å¤±è´¥:', e);
                }
            }
        }

        // è§£å‹æ–‡ä»¶
        function extractArchive(archivePath, outputDir) {
            return new Promise((resolve, reject) => {
                const path = window.require('path');
                const { spawn } = window.require('child_process');

                const fileName = archivePath.toLowerCase();
                let command, args;

                if (fileName.endsWith('.zip')) {
                    // ä½¿ç”¨PowerShellè§£å‹ZIPæ–‡ä»¶
                    command = 'powershell';
                    args = ['-Command', `Expand-Archive -Path "${archivePath}" -DestinationPath "${outputDir}" -Force`];
                } else if (fileName.endsWith('.tar') || fileName.endsWith('.tgz') || fileName.endsWith('.tar.gz')) {
                    // ä½¿ç”¨tarè§£å‹
                    command = 'tar';
                    args = ['-xf', archivePath, '-C', outputDir];
                } else {
                    reject(new Error('ä¸æ”¯æŒçš„å‹ç¼©æ ¼å¼'));
                    return;
                }

                const process = spawn(command, args);

                process.on('close', (code) => {
                    if (code === 0) {
                        resolve();
                    } else {
                        reject(new Error(`è§£å‹å¤±è´¥ï¼Œé€€å‡ºç : ${code}`));
                    }
                });

                process.on('error', (error) => {
                    reject(new Error(`è§£å‹å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${error.message}`));
                });
            });
        }

        // æŸ¥æ‰¾æ—¥å¿—æ–‡ä»¶
        function findLogFiles(dir) {
            const fs = window.require('fs');
            const path = window.require('path');

            const logFiles = [];
            const logExtensions = ['.log', '.txt', '.out', '.err'];

            function scanDirectory(currentDir) {
                try {
                    const items = fs.readdirSync(currentDir);

                    for (const item of items) {
                        const fullPath = path.join(currentDir, item);
                        const stat = fs.statSync(fullPath);

                        if (stat.isDirectory()) {
                            scanDirectory(fullPath);
                        } else if (stat.isFile()) {
                            const ext = path.extname(item).toLowerCase();
                            if (logExtensions.includes(ext) || item.toLowerCase().includes('log')) {
                                logFiles.push(fullPath);
                            }
                        }
                    }
                } catch (e) {
                    console.warn(`æ‰«æç›®å½• ${currentDir} å¤±è´¥:`, e);
                }
            }

            scanDirectory(dir);
            return logFiles;
        }

        // æœåŠ¡ç«¯è§„åˆ™åˆ†æ
        async function analyzeWithServerRules(content, filename) {
            try {
                const response = await fetch(`${settings.serverUrl}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        filename: filename
                    }),
                    signal: analysisController?.signal
                });

                if (!response.ok) {
                    throw new Error(`æœåŠ¡ç«¯åˆ†æå¤±è´¥: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw error;
                }
                console.error('æœåŠ¡ç«¯åˆ†æå¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°åˆ†æ:', error);
                showMessage('æœåŠ¡ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è§„åˆ™åˆ†æ', 'warning');
                return await analyzeLogContent(content, filename);
            }
        }

        // æœ¬åœ°æ—¥å¿—åˆ†æé€»è¾‘ï¼ˆåŸºäºæœåŠ¡ç«¯é€»è¾‘ï¼‰
        async function analyzeLogContent(content, filename) {
            try {
                console.log('å¼€å§‹åˆ†ææ–‡ä»¶:', filename, 'å†…å®¹é•¿åº¦:', content.length);

                if (!content || content.length === 0) {
                    throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                }

                const lines = content.split('\n');
                const issues = [];
                console.log('æ€»è¡Œæ•°:', lines.length);

                // è·å–å½“å‰è§„åˆ™
                const rules = await getCurrentRules();
                console.log('è·å–åˆ°è§„åˆ™æ•°é‡:', rules.length);

                if (!rules || rules.length === 0) {
                    console.warn('æ²¡æœ‰å¯ç”¨çš„è§„åˆ™');
                    return {
                        filename: filename,
                        total_lines: lines.length,
                        issues_found: 0,
                        issues: [],
                        analysis_time: new Date().toISOString()
                    };
                }

                // é€è¡Œåˆ†æ
                for (let i = 0; i < lines.length; i++) {
                    // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
                    if (analysisController?.signal.aborted) {
                        throw new DOMException('åˆ†æè¢«ä¸­æ–­', 'AbortError');
                    }

                    const line = lines[i];
                    if (!line.trim()) continue;

                    // åº”ç”¨è§„åˆ™æ£€æµ‹
                    for (const rule of rules) {
                        if (rule.is_active !== false && applyRule(line, rule)) {
                            issues.push({
                                line_number: i + 1,
                                content: line,
                                rule_name: rule.name,
                                problem_type: rule.problem_type,
                                problem_description: rule.problem_description || rule.description,
                                severity: rule.priority > 5 ? 'high' : 'medium'
                            });
                            break; // åªåº”ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™
                        }
                    }

                    // æ¯å¤„ç†1000è¡Œæ˜¾ç¤ºä¸€æ¬¡è¿›åº¦ï¼Œé¿å…é¢‘ç¹æ›´æ–°
                    if (i % 1000 === 0 && i > 0) {
                        const progress = Math.round((i / lines.length) * 100);
                        showMessage(`æ­£åœ¨åˆ†æ... ${progress}%`, 'info');
                        // è®©å‡ºæ§åˆ¶æƒï¼Œé¿å…é˜»å¡UIï¼ˆç¼©çŸ­æ—¶å»¶æå‡æµç•…åº¦ï¼‰
                        await pause(0);
                    }
                }

                console.log('åˆ†æå®Œæˆï¼Œå‘ç°é—®é¢˜:', issues.length);
                return {
                    filename: filename,
                    total_lines: lines.length,
                    issues_found: issues.length,
                    issues: issues,
                    analysis_time: new Date().toISOString()
                };
            } catch (error) {
                console.error('analyzeLogContent é”™è¯¯:', error);
                throw error;
            }
        }

        // è§„åˆ™åº”ç”¨é€»è¾‘
        function applyRule(content, rule) {
            try {
                const pattern = rule.pattern;
                const ruleType = rule.rule_type || 'regex';

                switch (ruleType) {
                    case 'regex':
                        return new RegExp(pattern, 'i').test(content);
                    case 'keyword':
                        return content.toLowerCase().includes(pattern.toLowerCase());
                    default:
                        return false;
                }
            } catch (e) {
                console.error('è§„åˆ™åº”ç”¨å¤±è´¥:', e);
                return false;
            }
        }

        // è·å–å½“å‰è§„åˆ™
        async function getCurrentRules() {
            // æ ¹æ®ç”¨æˆ·é€‰æ‹©å†³å®šä½¿ç”¨å“ªç§è§„åˆ™
            if (settings.useLocalRules) {
                // ä½¿ç”¨æœ¬åœ°è§„åˆ™ï¼Œä¸è¿æ¥æœåŠ¡ç«¯
                console.log('ä½¿ç”¨æœ¬åœ°è§„åˆ™');
                return getLocalRules();
            } else {
                // ä½¿ç”¨æœåŠ¡ç«¯è§„åˆ™
                try {
                    console.log('å°è¯•è·å–æœåŠ¡ç«¯è§„åˆ™');
                    const rules = await fetchRulesFromServer();
                    if (rules && rules.length > 0) {
                        currentRules = rules;
                        return rules;
                    }
                } catch (e) {
                    console.log('æœåŠ¡ç«¯è§„åˆ™è·å–å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°è§„åˆ™');
                    showMessage('æœåŠ¡ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è§„åˆ™', 'warning');
                }

                // å›é€€åˆ°æœ¬åœ°è§„åˆ™
                return getLocalRules();
            }
        }

        // ä»æœåŠ¡ç«¯è·å–è§„åˆ™
        async function fetchRulesFromServer() {
            try {
                // å…ˆä½¿ç”¨è§„èŒƒåŒ–åçš„ serverUrl
                sanitizeSettings();
                let url = `${settings.serverUrl}/api/v1/rules`;
                console.log('å°è¯•è·å–æœåŠ¡ç«¯è§„åˆ™:', url);

                try {
                    const response = await fetch(url);
                    console.log('æœåŠ¡ç«¯å“åº”çŠ¶æ€:', response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('æœåŠ¡ç«¯è¿”å›æ•°æ®:', data);

                        // å¤„ç†ä¸åŒçš„è¿”å›æ ¼å¼
                        let rules;
                        if (Array.isArray(data)) {
                            rules = data;
                        } else if (data.rules && Array.isArray(data.rules)) {
                            rules = data.rules;
                        } else {
                            console.error('æœåŠ¡ç«¯è¿”å›æ•°æ®æ ¼å¼é”™è¯¯:', data);
                            return null;
                        }

                        // ç§»é™¤æœåŠ¡ç«¯è§„åˆ™ä¸­çš„ priority å­—æ®µï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¸ä½¿ç”¨
                        rules = rules.map(rule => {
                            const { priority, ...ruleWithoutPriority } = rule;
                            return ruleWithoutPriority;
                        });

                        console.log('è·å–åˆ°æœåŠ¡ç«¯è§„åˆ™:', rules.length, 'æ¡');
                        return rules;
                    } else {
                        console.error('æœåŠ¡ç«¯å“åº”é”™è¯¯:', response.status, response.statusText);
                    }
                } catch (e1) {
                    console.warn('é¦–æ¬¡è¯·æ±‚å¤±è´¥ï¼Œå°è¯•ç«¯å£å›é€€:', e1);
                    // å¦‚æœä»ç„¶æœ‰ 8080 çš„å†å²åœ°å€ï¼Œå›é€€åˆ° 8001 å†è¯•ä¸€æ¬¡
                    const fallbackUrl = url.replace('localhost:8080', 'localhost:8001').replace('127.0.0.1:8080', '127.0.0.1:8001');
                    if (fallbackUrl !== url) {
                        console.log('å°è¯•å›é€€URL:', fallbackUrl);
                        const resp2 = await fetch(fallbackUrl);
                        if (resp2.ok) {
                            const rules = await resp2.json();
                            console.log('å›é€€URLæˆåŠŸï¼Œè·å–åˆ°è§„åˆ™:', rules.length, 'æ¡');
                            return rules;
                        }
                    }
                    throw e1;
                }
            } catch (e) {
                console.error('æœåŠ¡ç«¯è§„åˆ™è·å–å¤±è´¥:', e);
            }
            return null;
        }

        // è·å–æœ¬åœ°è§„åˆ™
        function getLocalRules() {
            try {
                const saved = localStorage.getItem('logAnalyzerRules');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('æœ¬åœ°è§„åˆ™åŠ è½½å¤±è´¥:', e);
            }

            // è¿”å›é»˜è®¤è§„åˆ™ï¼ˆä¸æœåŠ¡ç«¯å­—æ®µä¿æŒä¸€è‡´ï¼‰
            return [
                {
                    id: 1,
                    name: 'é”™è¯¯æ—¥å¿—è§„åˆ™',
                    description: 'åŒ¹é… ERROR çº§åˆ«æ—¥å¿—',
                    pattern: 'ERROR|error|Error',
                    rule_type: 'regex',
                    problem_type: 'error',
                    problem_description: 'åŒ¹é… ERROR çº§åˆ«æ—¥å¿—',
                    priority: 8,
                    is_active: true,
                    created_by: 1,
                    created_at: new Date().toISOString(),
                    updated_at: null
                },
                {
                    id: 2,
                    name: 'è­¦å‘Šæ—¥å¿—è§„åˆ™',
                    description: 'åŒ¹é… WARN çº§åˆ«æ—¥å¿—',
                    pattern: 'WARN|warn|Warning|WARNING',
                    rule_type: 'regex',
                    problem_type: 'warning',
                    problem_description: 'åŒ¹é… WARN çº§åˆ«æ—¥å¿—',
                    priority: 5,
                    is_active: true,
                    created_by: 1,
                    created_at: new Date().toISOString(),
                    updated_at: null
                },
                {
                    id: 3,
                    name: 'å¼‚å¸¸å †æ ˆè§„åˆ™',
                    description: 'åŒ¹é…å¼‚å¸¸å †æ ˆä¿¡æ¯',
                    pattern: 'Exception|exception|Traceback|traceback',
                    rule_type: 'regex',
                    problem_type: 'exception',
                    problem_description: 'åŒ¹é…å¼‚å¸¸å †æ ˆä¿¡æ¯',
                    priority: 9,
                    is_active: true,
                    created_by: 1,
                    created_at: new Date().toISOString(),
                    updated_at: null
                }
            ];
        }

        // ä¿å­˜æœ¬åœ°è§„åˆ™
        function saveLocalRules(rules) {
            try {
                localStorage.setItem('logAnalyzerRules', JSON.stringify(rules));
                currentRules = rules;
                updateRulesUI();
            } catch (e) {
                console.error('æœ¬åœ°è§„åˆ™ä¿å­˜å¤±è´¥:', e);
            }
        }

        // è§„åˆ™ç®¡ç†åŠŸèƒ½
        async function syncRules() {
            try {
                showMessage('æ­£åœ¨åŒæ­¥è§„åˆ™...', 'info');
                console.log('å¼€å§‹åŒæ­¥è§„åˆ™ï¼Œå½“å‰æœåŠ¡ç«¯åœ°å€:', settings.serverUrl);

                if (!settings.serverUrl) {
                    showMessage('è¯·å…ˆé…ç½®æœåŠ¡ç«¯åœ°å€', 'warning');
                    return;
                }

                const serverRules = await fetchRulesFromServer();
                console.log('æœåŠ¡ç«¯è§„åˆ™è·å–ç»“æœ:', serverRules);

                if (serverRules && Array.isArray(serverRules) && serverRules.length > 0) {
                    console.log('ä¿å­˜æœåŠ¡ç«¯è§„åˆ™åˆ°æœ¬åœ°:', serverRules);
                    saveLocalRules(serverRules);

                    // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
                    const savedRules = getLocalRules();
                    console.log('ä¿å­˜åæœ¬åœ°è§„åˆ™æ•°é‡:', savedRules.length);

                    showMessage(`æˆåŠŸåŒæ­¥ ${serverRules.length} æ¡è§„åˆ™`, 'success');
                } else {
                    console.warn('æœåŠ¡ç«¯è§„åˆ™ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯:', serverRules);
                    showMessage('æœåŠ¡ç«¯è¿æ¥å¤±è´¥æˆ–æ— å¯ç”¨è§„åˆ™', 'error');
                }

            } catch (error) {
                console.error('è§„åˆ™åŒæ­¥å¤±è´¥:', error);
                showMessage('è§„åˆ™åŒæ­¥å¤±è´¥: ' + error.message, 'error');
            }
        }



        function exportRules() {
            try {
                const rules = getLocalRules();
                const dataStr = JSON.stringify(rules, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'log_analyzer_rules.json';
                link.click();

                showMessage('è§„åˆ™å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('è§„åˆ™å¯¼å‡ºå¤±è´¥:', error);
                showMessage('è§„åˆ™å¯¼å‡ºå¤±è´¥', 'error');
            }
        }

        // æ›´æ–°è§„åˆ™ç•Œé¢
        function updateRulesUI() {
            const rulesList = document.getElementById('rules-list');
            if (!rulesList) return;

            const rules = getLocalRules();
            rulesList.innerHTML = '';

            rules.forEach(rule => {
                const ruleEl = document.createElement('div');
                ruleEl.style.cssText = 'padding: 16px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center;';

                const statusClass = rule.is_active ? 'status-success' : 'status-error';

                ruleEl.innerHTML = `
                    <div>
                        <span class="status-indicator ${statusClass}"></span>
                        <strong>${rule.name}</strong> - ${rule.problem_description || rule.description || ''}
                        <br><small style="color: #666;">æ¨¡å¼: ${rule.pattern}</small>
                        ${rule.priority !== undefined ? `<br><small style="color: #666;">ä¼˜å…ˆçº§: ${rule.priority}</small>` : ''}
                    </div>
                    <div>
                        <button onclick="editRule(${rule.id})" style="margin-right: 8px; padding: 4px 8px; border: 1px solid #1890ff; background: white; color: #1890ff; border-radius: 4px; cursor: pointer;">
                            ç¼–è¾‘
                        </button>
                        <button onclick="toggleRule(${rule.id})" style="margin-right: 8px; padding: 4px 8px; border: 1px solid #d9d9d9; background: white; border-radius: 4px; cursor: pointer;">
                            ${rule.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                        <button onclick="deleteRule(${rule.id})" style="padding: 4px 8px; border: 1px solid #ff4d4f; background: #ff4d4f; color: white; border-radius: 4px; cursor: pointer;">
                            åˆ é™¤
                        </button>
                    </div>
                `;

                rulesList.appendChild(ruleEl);
            });
        }

        // è§„åˆ™æ“ä½œ
        function toggleRule(ruleId) {
            const rules = getLocalRules();
            const rule = rules.find(r => r.id === ruleId);
            if (rule) {
                rule.is_active = !rule.is_active;
                saveLocalRules(rules);
                showMessage(`è§„åˆ™ "${rule.name}" å·²${rule.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
            }
        }

        function deleteRule(ruleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) return;

            const rules = getLocalRules();
            const filteredRules = rules.filter(r => r.id !== ruleId);
            saveLocalRules(filteredRules);
            showMessage('è§„åˆ™åˆ é™¤æˆåŠŸ', 'success');
        }

        // è§„åˆ™ç¼–è¾‘åŠŸèƒ½
        let currentEditingRule = null;

        function addRule() {
            currentEditingRule = null;
            document.getElementById('rule-modal-title').textContent = 'æ·»åŠ è§„åˆ™';
            clearRuleForm();
            showRuleModal();
        }

        function editRule(ruleId) {
            const rules = getLocalRules();
            const rule = rules.find(r => r.id === ruleId);
            if (!rule) return;

            currentEditingRule = rule;
            document.getElementById('rule-modal-title').textContent = 'ç¼–è¾‘è§„åˆ™';
            fillRuleForm(rule);
            showRuleModal();
        }

        function showRuleModal() {
            console.log('æ˜¾ç¤ºè§„åˆ™æ¨¡æ€æ¡†');
            console.trace('showRuleModal è°ƒç”¨å †æ ˆ');
            const modal = document.getElementById('rule-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                console.log('æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
            }
        }

        function closeRuleModal() {
            console.log('å…³é—­è§„åˆ™æ¨¡æ€æ¡†');
            const modal = document.getElementById('rule-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                console.log('æ¨¡æ€æ¡†å·²éšè—');
            } else {
                console.error('æ‰¾ä¸åˆ°è§„åˆ™æ¨¡æ€æ¡†å…ƒç´ ');
            }
            currentEditingRule = null;
            clearRuleForm();
        }

        function clearRuleForm() {
            document.getElementById('rule-name').value = '';
            document.getElementById('rule-description').value = '';
            document.getElementById('rule-pattern').value = '';
            document.getElementById('rule-type').value = 'regex';
            document.getElementById('rule-problem-type').value = '';
            document.getElementById('rule-problem-description').value = '';
            document.getElementById('rule-active').checked = true;
        }

        function fillRuleForm(rule) {
            document.getElementById('rule-name').value = rule.name || '';
            document.getElementById('rule-description').value = rule.description || '';
            document.getElementById('rule-pattern').value = rule.pattern || '';
            document.getElementById('rule-type').value = rule.rule_type || 'regex';
            document.getElementById('rule-problem-type').value = rule.problem_type || '';
            document.getElementById('rule-problem-description').value = rule.problem_description || '';
            document.getElementById('rule-active').checked = rule.is_active !== false;
        }

        function saveRule() {
            try {
                const name = document.getElementById('rule-name').value.trim();
                const description = document.getElementById('rule-description').value.trim();
                const pattern = document.getElementById('rule-pattern').value.trim();
                const ruleType = document.getElementById('rule-type').value;
                const problemType = document.getElementById('rule-problem-type').value.trim();
                const problemDescription = document.getElementById('rule-problem-description').value.trim();
                const isActive = document.getElementById('rule-active').checked;

                if (!name || !pattern) {
                    showMessage('è¯·å¡«å†™è§„åˆ™åç§°å’ŒåŒ¹é…æ¨¡å¼', 'warning');
                    return;
                }

                // éªŒè¯æ­£åˆ™è¡¨è¾¾å¼
                if (ruleType === 'regex') {
                    try {
                        new RegExp(pattern);
                    } catch (e) {
                        showMessage('æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: ' + e.message, 'error');
                        return;
                    }
                }

                const rules = getLocalRules();

                if (currentEditingRule) {
                    // ç¼–è¾‘ç°æœ‰è§„åˆ™
                    const index = rules.findIndex(r => r.id === currentEditingRule.id);
                    if (index !== -1) {
                        rules[index] = {
                            ...rules[index],
                            name,
                            description,
                            pattern,
                            rule_type: ruleType,
                            problem_type: problemType,
                            problem_description: problemDescription,
                            is_active: isActive,
                            updated_at: new Date().toISOString()
                        };
                    }
                } else {
                    // æ·»åŠ æ–°è§„åˆ™
                    const newId = Math.max(...rules.map(r => r.id), 0) + 1;
                    const newRule = {
                        id: newId,
                        name,
                        description,
                        pattern,
                        rule_type: ruleType,
                        problem_type: problemType,
                        problem_description: problemDescription,
                        is_active: isActive,
                        created_by: 1,
                        created_at: new Date().toISOString(),
                        updated_at: null
                    };
                    rules.push(newRule);
                }

                saveLocalRules(rules);
                closeRuleModal();
                showMessage(currentEditingRule ? 'è§„åˆ™æ›´æ–°æˆåŠŸ' : 'è§„åˆ™æ·»åŠ æˆåŠŸ', 'success');
            } catch (error) {
                console.error('ä¿å­˜è§„åˆ™æ—¶å‡ºé”™:', error);
                showMessage('ä¿å­˜è§„åˆ™å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function showAnalysisResult(result) {
            const reportPage = document.getElementById('report-page');
            if (!reportPage) return;

            reportPage.innerHTML = `
                <h1 class="page-title">åˆ†ææŠ¥å‘Š</h1>
                <p class="page-subtitle">æ–‡ä»¶: ${result.filename}</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: #f0f2ff; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: #667eea;">${result.total_lines}</div>
                        <div style="color: #666;">æ€»è¡Œæ•°</div>
                    </div>
                    <div style="background: #fff2e8; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: #fa8c16;">${result.issues_found}</div>
                        <div style="color: #666;">å‘ç°é—®é¢˜</div>
                    </div>
                    <div style="background: #f6ffed; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: #52c41a;">${(result.issues || []).filter(i => i.severity === 'high').length}</div>
                        <div style="color: #666;">é«˜å±é—®é¢˜</div>
                    </div>
                    ${result.files_analyzed ? `
                    <div style="background: #e6f7ff; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: #1890ff;">${result.files_analyzed}</div>
                        <div style="color: #666;">åˆ†ææ–‡ä»¶</div>
                    </div>
                    ` : ''}
                </div>

                <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 16px;">é—®é¢˜è¯¦æƒ…</h3>
                    <div id="issues-list">
                        <p style="color: #666; text-align: center; padding: 16px; margin: 0;">${(result.issues || []).length} æ¡é—®é¢˜ï¼Œå°†åˆ†æ‰¹æ¸²æŸ“ä»¥é¿å…å¡é¡¿...</p>
                    </div>
                    <div style="text-align:center; margin-top: 12px;">
                        <button id="load-more-btn" class="btn btn-secondary" type="button">åŠ è½½æ›´å¤š</button>
                    </div>
                </div>

                <div style="margin-top: 24px; text-align: center;">
                    <button class="btn" onclick="exportReport()">å¯¼å‡ºæŠ¥å‘Š</button>
                    <button class="btn btn-secondary" onclick="switchTab('home')">è¿”å›é¦–é¡µ</button>
                </div>
            `;

            // åˆ†æ‰¹æ¸²æŸ“ issuesï¼Œé¿å…ä¸€æ¬¡æ€§ç”Ÿæˆå·¨å¤§ innerHTML
            renderIssuesIncrementally(result.issues || [], 200);


            // ä¿å­˜æœ€æ–°æŠ¥å‘Šï¼ˆè¿›è¡Œä½“ç§¯è£å‰ªï¼Œé¿å… localStorage è¿‡å¤§å¯¼è‡´ RangeErrorï¼‰
            try {
                const slim = {
                    filename: result.filename,
                    total_lines: result.total_lines,
                    issues_found: result.issues_found,
                    analysis_time: result.analysis_time,
                    files_analyzed: result.files_analyzed,
                    // åªä¿å­˜é—®é¢˜çš„å…³é”®å­—æ®µï¼Œé™åˆ¶æœ€å¤š 500 æ¡
                    issues: (result.issues || []).slice(0, 500).map(it => ({
                        type: it.type,
                        severity: it.severity,
                        file: it.file || it.source_file,
                        line: it.line,
                        message: (it.message || '').slice(0, 500)
                    }))
                };
                localStorage.setItem('lastAnalysisResult', JSON.stringify(slim));
            } catch (e) {
                console.warn('ä¿å­˜åˆ†ææŠ¥å‘Šåˆ°æœ¬åœ°å¤±è´¥:', e);
            }
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport() {
            try {
                const result = JSON.parse(localStorage.getItem('lastAnalysisResult') || '{}');
                if (!result.filename) {
                    showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„æŠ¥å‘Š', 'warning');
                    return;
                }

                const reportText = generateReportText(result);
                const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `analysis_report_${result.filename}_${new Date().toISOString().slice(0, 10)}.txt`;
                link.click();




                showMessage('æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('æŠ¥å‘Šå¯¼å‡ºå¤±è´¥:', error);
                showMessage('æŠ¥å‘Šå¯¼å‡ºå¤±è´¥', 'error');
            }
        }

        // ç”ŸæˆæŠ¥å‘Šæ–‡æœ¬
        function generateReportText(result) {
            let text = `æ—¥å¿—åˆ†ææŠ¥å‘Š\n`;
            text += `================\n\n`;
            text += `æ–‡ä»¶å: ${result.filename || '-'}\n`;
            text += `åˆ†ææ—¶é—´: ${(result.analysis_time ? new Date(result.analysis_time).toLocaleString() : new Date().toLocaleString())}\n`;
            text += `æ€»è¡Œæ•°: ${result.total_lines || 0}\n`;
            text += `å‘ç°é—®é¢˜: ${result.issues_found || (result.issues ? result.issues.length : 0)}\n\n`;

            const issues = result.issues || [];
            if (issues.length > 0) {
                text += `é—®é¢˜è¯¦æƒ…:\n`;
                text += `--------\n\n`;

                issues.forEach((issue, index) => {
                    const ln = issue.line_number || issue.line || '-';
                    text += `${index + 1}. ${issue.rule_name || issue.type || 'è§„åˆ™å‘½ä¸­'} (ç¬¬ ${ln} è¡Œ)\n`;
                    text += `   ä¸¥é‡ç¨‹åº¦: ${issue.severity || '-'}\n`;
                    if (issue.problem_type) text += `   é—®é¢˜ç±»å‹: ${issue.problem_type}\n`;
                    if (issue.problem_description) text += `   é—®é¢˜æè¿°: ${issue.problem_description}\n`;
                    if (issue.file || issue.source_file) text += `   æ–‡ä»¶: ${issue.file || issue.source_file}\n`;
                    if (issue.content || issue.message) text += `   æ—¥å¿—å†…å®¹: ${(issue.content || issue.message)}\n`;
                    text += `\n`;
                });
            } else {
                text += `æœªå‘ç°é—®é¢˜ã€‚\n`;
            }

            return text;
        }

        // è®¾ç½®åŠŸèƒ½
        function saveAppSettings() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            const autoSync = document.getElementById('autoSync').checked;

            if (serverUrl && !serverUrl.startsWith('http')) {
                showMessage('æœåŠ¡ç«¯åœ°å€å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´', 'warning');
                return;
            }

            settings.serverUrl = serverUrl || 'http://172.17.20.117:8001';
            settings.autoSync = autoSync;

            saveSettings();
        }

        async function testConnection() {
            const serverUrl = document.getElementById('serverUrl').value.trim() || settings.serverUrl;

            if (!serverUrl) {
                showMessage('è¯·å…ˆè¾“å…¥æœåŠ¡ç«¯åœ°å€', 'warning');
                return;
            }

            try {
                showMessage('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');

                const response = await fetch(`${serverUrl}/api/v1/rules`, {
                    method: 'GET',
                    timeout: 5000
                });

                if (response.ok) {
                    showMessage('è¿æ¥æˆåŠŸï¼', 'success');
                } else {
                    showMessage(`è¿æ¥å¤±è´¥: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                showMessage('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰è§„åˆ™å’Œè®¾ç½®ã€‚')) {
                return;
            }

            try {
                localStorage.removeItem('logAnalyzerSettings');
                localStorage.removeItem('logAnalyzerRules');
                localStorage.removeItem('lastAnalysisResult');

                // é‡ç½®çŠ¶æ€
                settings = {
                    serverUrl: 'http://localhost:8001',
                    autoSync: true,
                    useLocalRules: true
                };
                currentRules = [];
                selectedFile = null;
                selectedBulkFile = null;

                // æ›´æ–°ç•Œé¢
                updateSettingsUI();
                updateRulesUI();

                showMessage('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
            } catch (error) {
                console.error('æ¸…é™¤æ•°æ®å¤±è´¥:', error);
                showMessage('æ¸…é™¤æ•°æ®å¤±è´¥', 'error');
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // åŠ è½½è®¾ç½®
            loadSettings();

            // ç¡®ä¿æ¨¡æ€æ¡†æ˜¯éšè—çš„
            const modal = document.getElementById('rule-modal');
            if (modal) {
                console.log('åˆå§‹åŒ–å‰æ¨¡æ€æ¡†ç±»å:', modal.className);
                modal.classList.add('hidden');
                console.log('åˆå§‹åŒ–åæ¨¡æ€æ¡†ç±»å:', modal.className);
                console.log('æ¨¡æ€æ¡†æ˜¯å¦éšè—:', modal.classList.contains('hidden'));
            } else {
                console.error('æ‰¾ä¸åˆ°è§„åˆ™æ¨¡æ€æ¡†å…ƒç´ ');
            }

            // æ›´æ–°è§„åˆ™ç•Œé¢
            updateRulesUI();

            // åˆå§‹åŒ–è§„åˆ™é€‰æ‹©çŠ¶æ€
            initializeRuleSourceUI();

            // å¦‚æœå¯ç”¨è‡ªåŠ¨åŒæ­¥ï¼Œå°è¯•åŒæ­¥è§„åˆ™
            // ä»…å½“é€‰æ‹©æœåŠ¡ç«¯è§„åˆ™æ—¶æ‰è‡ªåŠ¨åŒæ­¥ï¼Œé¿å…æœ¬åœ°è§„åˆ™æ¨¡å¼è§¦å‘ç½‘ç»œè¯·æ±‚
            if (settings.autoSync && !settings.useLocalRules) {
                setTimeout(() => {
                    syncRules();
                }, 1000);
            }

            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }

        // åˆå§‹åŒ–è§„åˆ™é€‰æ‹©ç•Œé¢
        function initializeRuleSourceUI() {
            // è®¾ç½®å•ä¸ªåˆ†æé¡µé¢çš„è§„åˆ™é€‰æ‹©
            const singleRadios = document.querySelectorAll('input[name="ruleSource"]');
            singleRadios.forEach(radio => {
                if (radio.value === (settings.useLocalRules ? 'local' : 'server')) {
                    radio.checked = true;
                }
            });

            // è®¾ç½®å…¨é‡åˆ†æé¡µé¢çš„è§„åˆ™é€‰æ‹©
            const bulkRadios = document.querySelectorAll('input[name="bulkRuleSource"]');
            bulkRadios.forEach(radio => {
                if (radio.value === (settings.useLocalRules ? 'local' : 'server')) {
                    radio.checked = true;
                }
            });

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateRuleSource(settings.useLocalRules ? 'local' : 'server');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–

        // åˆ†æ‰¹æ¸²æŸ“å‡½æ•°ï¼šæ¯æ‰¹ batchSize æ¡ï¼Œç‚¹å‡»â€œåŠ è½½æ›´å¤šâ€æˆ–è‡ªåŠ¨é¦–æ‰¹
        function renderIssuesIncrementally(allIssues, batchSize = 200) {
            try {
                const container = document.getElementById('issues-list');
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (!container) return;

                let index = 0;
                function renderBatch() {
                    const end = Math.min(index + batchSize, allIssues.length);
                    const frag = document.createDocumentFragment();
                    for (let i = index; i < end; i++) {
                        const issue = allIssues[i] || {};
                        const div = document.createElement('div');
                        div.style.borderBottom = '1px solid #f0f0f0';
                        div.style.padding = '16px 0';
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                                <strong style="color: ${issue.severity === 'high' ? '#ff4d4f' : '#fa8c16'};">${issue.rule_name || issue.type || 'è§„åˆ™å‘½ä¸­'}</strong>
                                <div style="text-align:right;">
                                    ${issue.source_file ? `<div style="background:#f0f0f0; color:#666; padding:2px 8px; border-radius:4px; font-size:11px; margin-bottom:4px;">${issue.source_file}</div>` : ''}
                                    <span style="background:${issue.severity === 'high' ? '#ff4d4f' : '#fa8c16'}; color:white; padding:2px 8px; border-radius:4px; font-size:12px;">ç¬¬ ${issue.line_number || issue.line || '-'} è¡Œ</span>
                                </div>
                            </div>
                            <div style="color:#666; margin-bottom:8px;">${issue.problem_description || ''}</div>
                            <div style="background:#f8f8f8; padding:8px; border-radius:4px; font-family:monospace; font-size:12px; overflow-x:auto;">${issue.content || issue.message || ''}</div>
                        `;
                        frag.appendChild(div);
                    }
                    if (index === 0) container.innerHTML = '';
                    container.appendChild(frag);
                    index = end;
                    if (loadMoreBtn) loadMoreBtn.style.display = index < allIssues.length ? 'inline-block' : 'none';
                }

                // åˆæ¬¡æ¸²æŸ“
                renderBatch();
                if (loadMoreBtn) loadMoreBtn.onclick = renderBatch;
            } catch (e) {
                console.error('renderIssuesIncrementally error:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // ç«‹å³éšè—æ¨¡æ€æ¡†
            const modal = document.getElementById('rule-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('DOMContentLoaded: å¼ºåˆ¶éšè—æ¨¡æ€æ¡†');
            }

            // ç„¶ååˆå§‹åŒ–åº”ç”¨
            initApp();
        });

        // æ·»åŠ æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('rule-modal');
            if (event.target === modal) {
                closeRuleModal();
            }
        });

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨ï¼Œæ”¯æŒ ESC é”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('rule-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    closeRuleModal();
                }
            }
        });
    </script>
</body>
</html>
